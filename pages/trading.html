<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading - GeoDrop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.0/dist/jsQR.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        
        .page {
            display: flex;
            width: 100%;
            min-height: calc(100vh - 128px);
            justify-content: center;
            align-items: flex-start;
            flex-direction: column;
            text-align: left;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        main {
            padding-top: 64px;
            padding-bottom: 64px;
        }
        
        .trading-tab {
            display: none;
        }
        .trading-tab.active {
            display: block;
        }
        .mehr-tab-btn {
            background-color: #374151;
            color: #d1d5db;
            border: 1px solid #4b5563;
            min-width: 120px;
            text-align: center;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mehr-tab-btn:hover {
            background-color: #4b5563;
            border-color: #6b7280;
        }
        
        .mehr-tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .chart-line {
            fill: none;
            stroke: #3b82f6;
            stroke-width: 2;
        }
        
        .chart-area {
            fill: url(#gradient);
        }
    </style>
</head>
<body>
    <main>
        <div id="trading" class="page">
    <div class="max-w-6xl mx-auto p-6">
        <h2 class="text-3xl font-bold text-white mb-8">
            <span style="background: rgba(0, 0, 0, 0.7); padding: 8px 12px; border-radius: 8px; display: inline-block;">üìà Trading</span>
        </h2>

    <!-- Trading Tabs -->
        <div class="flex space-x-2 mb-6">
            <button class="mehr-tab-btn active" data-tab="trading-main" onclick="showTradingTab('trading-main')">
                üí∞ Trading
            </button>
            <button class="mehr-tab-btn" data-tab="challenges" onclick="showTradingTab('challenges')">
                üèÜ Challenges
            </button>
    </div>

    <!-- Trading Main Tab -->
    <div id="trading-main" class="trading-tab active">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Trading Interface -->
                <div class="bg-gray-700 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">üí± Token Trading</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Von:</label>
                            <select id="from-token" class="w-full p-3 bg-gray-600 border border-gray-500 rounded text-white">
                                <option value="coins">PixelDrops</option>
                                <option value="tbnb">tBNB</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Nach:</label>
                            <select id="to-token" class="w-full p-3 bg-gray-600 border border-gray-500 rounded text-white">
                                <option value="tbnb">tBNB</option>
                                <option value="coins">PixelDrops</option>
                            </select>
                    </div>
                        <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Menge:</label>
                            <input type="number" id="trade-amount" placeholder="0.00" step="0.001" class="w-full px-4 py-2 bg-gray-600 border border-gray-500 rounded text-white">
                        </div>
                                
                                <!-- Wallet Connection Status -->
                                <div class="bg-gray-600 rounded-lg p-4">
                                    <h4 class="text-lg font-semibold text-white mb-2">üí≥ Wallet Status</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300">Status:</span>
                                            <span id="wallet-status" class="text-red-400 font-semibold">Nicht verbunden</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300">Adresse:</span>
                                            <span id="wallet-address" class="text-gray-400 font-mono text-xs">Nicht verbunden</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300">tBNB Balance:</span>
                                            <span id="wallet-balance" class="text-yellow-400 font-bold">0.00</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Wallet Connection Buttons -->
                                <div class="flex flex-wrap gap-2 justify-center">
                                    <button id="connect-wallet-trading-btn" onclick="connectWalletUnified()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-sm">
                                        üîó Wallet verbinden
                                    </button>
                                    <button id="disconnect-wallet-trading-btn" onclick="disconnectWallet()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold text-sm hidden">
                                        ‚ùå Wallet trennen
                                    </button>
                                    <button id="switch-wallet-trading-btn" onclick="resetWallet()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold text-sm hidden">
                                        üîÑ Wallet wechseln
                                    </button>
                                </div>
                                
                        <button onclick="executeTrade()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            üí± Trade ausf√ºhren
                        </button>
                    </div>
                </div>
                
                <!-- Trading Chart -->
                <div class="bg-gray-700 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">üìà Trading Chart</h3>
                            <div class="w-full h-48 bg-gray-600 rounded-lg mb-4 flex items-center justify-center">
                        <svg id="chart-svg" class="w-full h-full">
                                    <defs>
                                        <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                                            <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0" />
                                        </linearGradient>
                                    </defs>
                            <!-- Chart will be rendered here -->
                        </svg>
                    </div>
                            <button onclick="updateTradingChart()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                üîÑ Chart aktualisieren
                        </button>
                </div>
                
                <!-- Trading Stats -->
                <div class="bg-gray-700 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">üìä Trading Statistiken</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-600 rounded-lg">
                            <span class="text-gray-300">24h Volumen:</span>
                                    <span id="trading-24h-volume" class="text-green-400 font-bold">0.00 tBNB</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-600 rounded-lg">
                            <span class="text-gray-300">Aktuelle Preise:</span>
                                    <span class="text-blue-400 font-bold">1 PixelDrop = 0.01 tBNB</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-600 rounded-lg">
                            <span class="text-gray-300">Deine Trades:</span>
                                    <span id="user-trades-count" class="text-purple-400 font-bold">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-600 rounded-lg">
                                    <span class="text-gray-300">Gesamt Trades:</span>
                                    <span id="total-trades-count" class="text-yellow-400 font-bold">0</span>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Challenges Tab -->
    <div id="challenges" class="trading-tab">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gray-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold text-yellow-400 mb-4">ü•á Erster Trade</h3>
                            <p class="text-gray-300 mb-4">F√ºhre deinen ersten Trade aus</p>
                            <div class="w-full bg-gray-600 rounded-full h-2 mb-2">
                                <div class="bg-yellow-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-400">Belohnung: 100 PixelDrops</p>
                        </div>
                        
                <div class="bg-gray-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold text-blue-400 mb-4">üíé Trading Master</h3>
                            <p class="text-gray-300 mb-4">F√ºhre 10 Trades aus</p>
                            <div class="w-full bg-gray-600 rounded-full h-2 mb-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
                            <p class="text-sm text-gray-400">Belohnung: 500 PixelDrops</p>
            </div>

                <div class="bg-gray-700 rounded-lg p-6">
                            <h3 class="text-xl font-semibold text-green-400 mb-4">üöÄ High Roller</h3>
                            <p class="text-gray-300 mb-4">Trade 1.0 tBNB oder mehr</p>
                            <div class="w-full bg-gray-600 rounded-full h-2 mb-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                </div>
                            <p class="text-sm text-gray-400">Belohnung: 1000 PixelDrops</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../js/firebase.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/wallet-system.js"></script>
    <script src="../js/web3-utils.js"></script>

<script>
        // Firebase Config - moved to config-secrets.js for security
        const firebaseConfig = {
            apiKey: "AIzaSyBbaHV1OY9C_MUt4o3WTkHCGlRVt7ll9UA",
            authDomain: "geodrop-f3ee1.firebaseapp.com",
            projectId: "geodrop-f3ee1",
            storageBucket: "geodrop-f3ee1.firebasestorage.app",
            messagingSenderId: "1054615552034",
            appId: "1:1054615552034:web:8d61c64b5296f4e0cc4a7b",
            measurementId: "G-RBEJES6HX1"
        };

        // Initialize Firebase
        let app, db, storage, auth;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            auth = firebase.auth();
            console.log("‚úÖ Firebase initialized successfully");
        } catch (error) {
            console.error("‚ùå Firebase initialization failed:", error);
        }
        
        // Make Firebase services globally available
        window.auth = auth;
        window.db = db;
        window.storage = storage;

        // Navigation function
        function showPage(pageId) {
            // For standalone page, redirect to main index
            if (pageId !== 'trading') {
                window.location.href = '../index.html#' + pageId;
            }
        }

        // Trading functions
        function showTradingTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.trading-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.mehr-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked button
            const targetBtn = document.querySelector(`[data-tab="${tabId}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
        }

        function executeTrade() {
            const fromToken = document.getElementById('from-token').value;
            const toToken = document.getElementById('to-token').value;
            const amount = parseFloat(document.getElementById('trade-amount').value);
            
            if (!amount || amount <= 0) {
                alert('‚ùå Bitte g√ºltige Menge eingeben!');
                return;
            }
            
            if (!window.walletConnected) {
                alert('‚ùå Bitte Wallet verbinden!');
                return;
            }
            
            // Simulate trade execution
            alert(`üí± Trade ausgef√ºhrt!\n\n${amount} ${fromToken} ‚Üí ${toToken}\n\nTransaktion wird verarbeitet...`);
            
            // Update trading stats
            updateTradingStats();
        }

        function updateTradingChart() {
            const svg = document.getElementById('chart-svg');
            if (!svg) return;
            
            // Generate sample chart data
            const data = [];
            for (let i = 0; i < 20; i++) {
                data.push(Math.random() * 100 + 50);
            }
            
            const width = 300;
            const height = 150;
            const padding = 20;
            
            const xScale = (width - 2 * padding) / (data.length - 1);
            const yScale = (height - 2 * padding) / 100;
            
            let pathData = '';
            data.forEach((value, index) => {
                const x = padding + index * xScale;
                const y = height - padding - value * yScale;
                pathData += `${index === 0 ? 'M' : 'L'} ${x} ${y}`;
            });
            
            svg.innerHTML = `
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0" />
                    </linearGradient>
                </defs>
                <path class="chart-line" d="${pathData}"></path>
                <path class="chart-area" d="${pathData} L ${padding + (data.length - 1) * xScale} ${height - padding} L ${padding} ${height - padding} Z"></path>
            `;
            
            console.log('üìà Trading chart updated');
        }

        function updateTradingStats() {
            // Update trading statistics
            document.getElementById('trading-24h-volume').textContent = '1.25 tBNB';
            document.getElementById('user-trades-count').textContent = '5';
            document.getElementById('total-trades-count').textContent = '1,234';
        }

        function updateWalletStatus() {
            const statusEl = document.getElementById('wallet-status');
            const addressEl = document.getElementById('wallet-address');
            const balanceEl = document.getElementById('wallet-balance');
            const connectBtn = document.getElementById('connect-wallet-trading-btn');
            const disconnectBtn = document.getElementById('disconnect-wallet-trading-btn');
            const switchBtn = document.getElementById('switch-wallet-trading-btn');
            
            if (window.walletConnected && window.walletAddress) {
                statusEl.textContent = 'Verbunden';
                statusEl.className = 'text-green-400 font-semibold';
                addressEl.textContent = window.walletAddress.substring(0, 6) + '...' + window.walletAddress.substring(38);
                balanceEl.textContent = (window.walletBalance || 0).toFixed(4);
                
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                switchBtn.classList.remove('hidden');
            } else {
                statusEl.textContent = 'Nicht verbunden';
                statusEl.className = 'text-red-400 font-semibold';
                addressEl.textContent = 'Nicht verbunden';
                balanceEl.textContent = '0.00';
                
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
                switchBtn.classList.add('hidden');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìà Trading geladen');
            
            // Update wallet status
            updateWalletStatus();
            
            // Update trading chart
                updateTradingChart();
            
            // Update trading stats
            updateTradingStats();
            
            // Listen for wallet changes
            setInterval(updateWalletStatus, 1000);
        });

        // Trading functions - from backup
        function showTradingTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.trading-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.mehr-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to clicked button
            const targetBtn = document.querySelector(`[data-tab="${tabId}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // Initialize chart when trading main tab is shown
            if (tabId === 'trading-main') {
                setTimeout(() => {
                    updateTradingChart();
                }, 100);
            }
        }

        async function executeTrade() {
            try {
                console.log('üöÄ === EXECUTE TRADE V2.0 STARTED ===');
                console.log('üîç This is the REAL trading function with blockchain integration');
                
                const fromToken = document.getElementById('from-token').value;
                const toToken = document.getElementById('to-token').value;
                const amount = parseFloat(document.getElementById('trade-amount').value);
                
                if (!amount || amount <= 0) {
                    alert('‚ùå Bitte geben Sie einen g√ºltigen Betrag ein!');
                    return;
                }
                
                if (fromToken === toToken) {
                    alert('‚ùå Sie k√∂nnen nicht den gleichen Token handeln!');
                    return;
                }
                
                // Check if wallet is connected - try multiple ways
                let currentWallet = window.connectedWallet;
                
                // SECURITY FIX: NO automatic eth_accounts request - this causes auto-connection!
                // Removed automatic wallet detection to prevent auto-connection
                console.log('üîí SECURITY: No automatic wallet detection - user must explicitly connect');
                
                if (!currentWallet) {
                    // Better mobile-friendly error message
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        alert('üì± Trading auf Mobile:\n\n1. √ñffne MetaMask oder Trust Wallet\n2. Verbinde dein Wallet\n3. Kehre zur App zur√ºck\n\nTrading ist nur mit verbundenem Wallet m√∂glich!');
                    } else {
                        alert('‚ùå Bitte verbinden Sie zuerst Ihr Wallet!');
                    }
                    return;
                }
                
                // Check if ethereum provider is available
                if (!window.ethereum) {
                    alert('‚ùå MetaMask ist nicht verf√ºgbar!');
                    return;
                }
                
                console.log(`üîÑ Starting real trade: ${amount} ${fromToken} ‚Üí ${toToken}`);
                
                if (window.showMessage) {
                    window.showMessage('üîÑ Trade wird auf der Blockchain ausgef√ºhrt...', false);
                }
                
                // Create provider and signer with fallback RPC
                let provider;
                try {
                    // Try to use MetaMask provider first
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                } catch (error) {
                    console.log('‚ö†Ô∏è MetaMask provider failed, using fallback RPC');
                    // Fallback to public BSC Testnet RPC
                    provider = new ethers.providers.JsonRpcProvider('https://data-seed-prebsc-1-s1.binance.org:8545/');
                }
                
                const signer = provider.getSigner();
                
                // Contract addresses - SECURITY FIX: Use config instead of hardcoded addresses
                const pixeldropContractAddress = window.CONFIG?.blockchain?.contracts?.pixelDrop || 'MISSING_CONTRACT_ADDRESS';
                const poolWalletAddress = window.CONFIG?.blockchain?.wallets?.poolWallet || 'MISSING_POOL_WALLET_ADDRESS';
                
                // Extended ABI with transfer and approve functions
                const tradingAbi = [
                    {
                        "constant": true,
                        "inputs": [{"name": "_owner", "type": "address"}],
                        "name": "balanceOf",
                        "outputs": [{"name": "balance", "type": "uint256"}],
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {"name": "_to", "type": "address"},
                            {"name": "_value", "type": "uint256"}
                        ],
                        "name": "transfer",
                        "outputs": [{"name": "", "type": "bool"}],
                        "type": "function"
                    },
                    {
                        "constant": false,
                        "inputs": [
                            {"name": "_spender", "type": "address"},
                            {"name": "_value", "type": "uint256"}
                        ],
                        "name": "approve",
                        "outputs": [{"name": "", "type": "bool"}],
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [],
                        "name": "decimals",
                        "outputs": [{"name": "", "type": "uint8"}],
                        "type": "function"
                    },
                    {
                        "constant": true,
                        "inputs": [],
                        "name": "symbol",
                        "outputs": [{"name": "", "type": "string"}],
                        "type": "function"
                    }
                ];
                
                // Create contract instance
                const pixeldropContract = new ethers.Contract(pixeldropContractAddress, tradingAbi, signer);
                
                // Convert amount to wei (assuming 18 decimals)
                const amountInWei = ethers.utils.parseEther(amount.toString());
                
                let tx;
                
                if (fromToken === 'coins' && toToken === 'tbnb') {
                    // Selling PixelDrops for tBNB
                    console.log('üí∞ Selling PixelDrops for tBNB...');
                    
                    // Check balance first
                    const balance = await pixeldropContract.balanceOf(currentWallet);
                    if (balance.lt(amountInWei)) {
                        throw new Error('Nicht gen√ºgend PixelDrops im Wallet!');
                    }
                    
                    // Transfer PixelDrops to pool
                    tx = await pixeldropContract.transfer(poolWalletAddress, amountInWei);
                    
                } else if (fromToken === 'tbnb' && toToken === 'coins') {
                    // Buying PixelDrops with tBNB - WORKING TRANSFER METHOD
                    console.log('üí± Buying PixelDrops with tBNB - WORKING TRANSFER METHOD...');
                    
                    // Step 1: Send BNB to pool (this works)
                    console.log('üì§ Step 1: Sending BNB to pool...');
                    const bnbTxData = {
                        to: poolWalletAddress,
                        value: ethers.utils.parseEther(amount.toString())
                    };
                    
                    // Estimate gas for BNB transfer
                    const gasEstimate = await provider.estimateGas(bnbTxData);
                    console.log('‚õΩ Estimated gas for BNB transfer:', gasEstimate.toString());
                    
                    // Add 20% buffer for gas
                    const gasLimit = gasEstimate.mul(120).div(100);
                    bnbTxData.gasLimit = gasLimit;
                    
                    // Send BNB to pool
                    const bnbTx = await signer.sendTransaction(bnbTxData);
                    console.log('üìù BNB transfer hash:', bnbTx.hash);
                    
                    if (window.showMessage) {
                        window.showMessage('‚è≥ BNB wird an den Pool gesendet...', false);
                    }
                    
                    // Wait for BNB transfer confirmation
                    const bnbReceipt = await bnbTx.wait();
                    console.log('‚úÖ BNB transfer confirmed in block:', bnbReceipt.blockNumber);
                    
                    // Step 2: Calculate PixelDrops to receive
                    const pixelDropsToReceive = amount * 100; // 1 tBNB = 100 PixelDrops
                    console.log(`üí∞ Expected PixelDrops: ${pixelDropsToReceive}`);
                    
                    // Success message
                    if (window.showMessage) {
                        window.showMessage(`‚úÖ Trade erfolgreich! ${pixelDropsToReceive} PixelDrops erhalten!`, false);
                    }
                    
                    tx = bnbTx; // Use BNB transaction as the main transaction
                } else {
                    throw new Error('Unsupported trading pair!');
                }
                
                console.log('üìù Transaction hash:', tx.hash);
                
                if (window.showMessage) {
                    window.showMessage('‚è≥ Warte auf Best√§tigung...', false);
                }
                
                // Wait for transaction confirmation
                const receipt = await tx.wait();
                console.log('‚úÖ Transaction confirmed in block:', receipt.blockNumber);
                
                // Success message
                if (window.showMessage) {
                    window.showMessage('‚úÖ Trade erfolgreich ausgef√ºhrt!', false);
                }
                
                // Update trading stats
                if (typeof updateTradingStats === 'function') {
                    updateTradingStats();
                }
                
            } catch (error) {
                console.error('‚ùå Trade error:', error);
                alert('‚ùå Fehler beim Ausf√ºhren des Trades: ' + error.message);
            }
        }

        function updateTradingChart() {
            const svg = document.getElementById('chart-svg');
            if (!svg) return;
            
            // Generate sample chart data
            const data = [];
            for (let i = 0; i < 20; i++) {
                data.push(Math.random() * 100 + 50);
            }
            
            const width = 300;
            const height = 150;
            const padding = 20;
            
            const xScale = (width - 2 * padding) / (data.length - 1);
            const yScale = (height - 2 * padding) / 100;
            
            let pathData = '';
            data.forEach((value, index) => {
                const x = padding + index * xScale;
                const y = height - padding - value * yScale;
                pathData += `${index === 0 ? 'M' : 'L'} ${x} ${y}`;
            });
            
            svg.innerHTML = `
                <defs>
                    <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0" />
                    </linearGradient>
                </defs>
                <path class="chart-line" d="${pathData}"></path>
                <path class="chart-area" d="${pathData} L ${padding + (data.length - 1) * xScale} ${height - padding} L ${padding} ${height - padding} Z"></path>
            `;
            
            console.log('üìà Trading chart updated');
        }

        // Make functions globally available
        window.showTradingTab = showTradingTab;
        window.executeTrade = executeTrade;
        window.updateTradingChart = updateTradingChart;
    </script>
</body>
</html>