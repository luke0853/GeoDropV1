<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonus System - GeoDrop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.0.0/dist/jsQR.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        
        .page {
            display: flex;
            width: 100%;
            min-height: calc(100vh - 128px);
            justify-content: center;
            align-items: flex-start;
            flex-direction: column;
            text-align: left;
            padding: 1rem;
            box-sizing: border-box;
        }
        
        main {
            padding-top: 64px;
            padding-bottom: 64px;
        }
        
        /* ORIGINAL BACKUP ANIMATIONS */
        @keyframes fly-away {
            from {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -1000px) scale(2);
                opacity: 0;
            }
        }
        
        @keyframes particle-fly {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                filter: hue-rotate(0deg);
            }
            100% {
                transform: translateY(-1000px) rotate(720deg);
                opacity: 0;
                filter: hue-rotate(360deg);
            }
        }
        
        @keyframes bonusFloat {
            0% {
                transform: translateY(100vh) scale(0.5);
                opacity: 0;
            }
            20% {
                transform: translateY(80vh) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0.8);
                opacity: 0;
            }
        }
        
        @keyframes bonusFloatNew {
            0% {
                transform: translateY(0) translateX(0) scale(0.5);
                opacity: 0;
            }
            10% {
                transform: translateY(20vh) translateX(0) scale(1.2);
                opacity: 1;
            }
            30% {
                transform: translateY(40vh) translateX(0) scale(1.0);
                opacity: 1;
            }
            100% {
                transform: translateY(-120vh) translateX(0) scale(0.8);
                opacity: 0;
            }
        }
        
        .floating-element {
            position: fixed;
            font-size: 3rem;
            z-index: 1000;
            animation: fly-away 1.5s ease-out forwards;
        }
        
        .bonus-particle {
            position: fixed;
            font-size: 2rem;
            opacity: 0;
            animation: particle-fly 2s ease-out forwards;
            pointer-events: none;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <main>
        <div id="bonus" class="page">
            <div class="max-w-4xl mx-auto p-6">
                <h2 class="text-3xl font-bold text-white mb-8">
                    <span style="background: rgba(0, 0, 0, 0.7); padding: 8px 12px; border-radius: 8px; display: inline-block;">üéÅ Bonus System</span>
                </h2>
                
                <div class="space-y-6">
                    <div class="bg-gray-700 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-white mb-4">T√§gliche Belohnungen</h3>
                        <p class="text-gray-300 mb-4">Logge dich t√§glich ein und erhalte Bonus-PixelDrop!</p>
                        
                        <!-- Bonus Status -->
                        <div class="bonus-status">
                            <div id="bonus-available" style="display: none;">
                                <div class="text-center">
                                    <div class="text-8xl mb-6 animate-bounce">üéÅ</div>
                                    <h3 class="text-2xl font-bold text-green-400 mb-4">T√§glicher Bonus!</h3>
                                    <p class="text-gray-300 mb-6 text-lg">Hole dir deinen t√§glichen Bonus und sammle PixelDrop!</p>
                                    <button onclick="claimBonus()" class="px-8 py-4 bg-gradient-to-r from-green-600 to-green-500 text-white rounded-lg hover:from-green-700 hover:to-green-600 transition-all duration-300 font-bold text-xl shadow-lg hover:shadow-xl transform hover:scale-105">
                                        üí∞ Bonus Abholen!
                                    </button>
                                    <p class="text-sm text-gray-400 mt-4">Reset jeden Tag um 6:00 Uhr morgens</p>
                                </div>
                            </div>
                            
                            <div id="bonus-claimed" style="display: none;">
                                <div class="text-center">
                                    <div class="text-8xl mb-6 animate-spin">‚è∞</div>
                                    <h3 class="text-2xl font-bold text-yellow-400 mb-4">Komm morgen wieder!</h3>
                                    <p class="text-gray-300 mb-6 text-lg">Hole dir deinen neuen Bonus!</p>
                                    <div id="bonus-countdown" class="bg-gray-600 rounded-lg p-6 border-2 border-yellow-400">
                                        <p class="text-gray-300 text-lg mb-2">N√§chster Reset in:</p>
                                        <p class="text-4xl font-bold text-yellow-400 animate-pulse" id="countdown-timer">--:--:--</p>
                                        <p class="text-sm text-gray-400 mt-2">‚≠ê Reset jeden Tag um 6:00 Uhr morgens</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bonus History -->
                    <div class="bg-gradient-to-r from-gray-700 to-gray-600 rounded-lg p-6 shadow-lg border border-gray-500">
                        <h3 class="text-xl font-semibold text-white mb-4 text-center">üìä Bonus-Verlauf</h3>
                        <div id="bonus-history-list" class="space-y-3">
                            <!-- Bonus-Historie wird hier dynamisch eingef√ºgt -->
                            <div class="text-center text-gray-400 py-4">
                                <div class="animate-spin text-4xl mb-2">‚è≥</div>
                                <p>Lade Bonus-Verlauf...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-700 rounded-lg p-6">
                        <h3 class="text-xl font-semibold text-white mb-4">Achievement System</h3>
                        <p class="text-gray-300 mb-4">Sammle Achievements und erhalte spezielle Belohnungen.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-gray-600 rounded-lg">
                                <h4 class="text-lg font-semibold text-yellow-400 mb-2">üèÜ Erste Schritte</h4>
                                <p class="text-gray-300 text-sm">Erstelle dein Konto</p>
                                <div class="w-full bg-gray-500 rounded-full h-2 mt-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                            </div>
                            <div class="p-4 bg-gray-600 rounded-lg">
                                <h4 class="text-lg font-semibold text-yellow-400 mb-2">üó∫Ô∏è Entdecker</h4>
                                <p class="text-gray-300 text-sm">Besuche 10 verschiedene Orte</p>
                                <div class="w-full bg-gray-500 rounded-full h-2 mt-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 30%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="../js/firebase.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/wallet-functions.js"></script>
    <script src="../js/bonus-functions.js"></script>
    
    <script>
        // Firebase Config from global CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBbaHV1OY9C_MUt4o3WTkHCGlRVt7ll9UA",
            authDomain: "geodrop-f3ee1.firebaseapp.com",
            projectId: "geodrop-f3ee1",
            storageBucket: "geodrop-f3ee1.firebasestorage.app",
            messagingSenderId: "1054615552034",
            appId: "1:1054615552034:web:8d61c64b5296f4e0cc4a7b",
            measurementId: "G-RBEJES6HX1"
        };

        // Initialize Firebase
        let app, db, storage, auth;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            auth = firebase.auth();
            console.log("‚úÖ Firebase initialized successfully");
        } catch (error) {
            console.error("‚ùå Firebase initialization failed:", error);
        }
        
        // Make Firebase services globally available
        window.auth = auth;
        window.db = db;
        window.storage = storage;

        // Navigation function
        function showPage(pageId) {
            // For standalone page, redirect to main index
            if (pageId !== 'bonus') {
                window.location.href = '../index.html#' + pageId;
            }
        }

        // Message function for bonus system
        function showMessage(message, isError = false) {
            if (isError) {
                console.error('‚ùå', message);
                alert('‚ùå ' + message);
            } else {
                console.log('‚úÖ', message);
                alert('‚úÖ ' + message);
            }
        }

        // Update user profile function
        window.updateUserProfile = async function() {
            if (!window.currentUser || !window.userProfile) {
                console.error('‚ùå No user or profile to update');
                return;
            }
            
            try {
                await db.collection('users').doc(window.currentUser.uid).set(window.userProfile, { merge: true });
                console.log('‚úÖ User profile updated successfully');
            } catch (error) {
                console.error('‚ùå Error updating user profile:', error);
                throw error;
            }
        };

        // Bonus functions

        function initializeBonusSystem() {
            console.log('üéÅ Initializing Bonus System...');
            
            // Load daily bonus content
            const bonusContainer = document.getElementById('bonus-container');
            if (bonusContainer) {
                bonusContainer.innerHTML = `
                    <div class="bg-gray-600 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-green-400 mb-2">üéÅ T√§glicher Login Bonus</h4>
                        <p class="text-gray-300 text-sm mb-4">Erhalte jeden Tag PixelDrop f√ºr deine Aktivit√§t!</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-3 bg-gray-500 rounded-lg">
                                <div class="text-xl font-bold text-yellow-400">100</div>
                                <div class="text-xs text-gray-400">PixelDrop</div>
                            </div>
                            <div class="text-center p-3 bg-gray-500 rounded-lg">
                                <div class="text-xl font-bold text-blue-400">Tag 1</div>
                                <div class="text-xs text-gray-400">Streak</div>
                            </div>
                            <div class="text-center p-3 bg-gray-500 rounded-lg">
                                <div class="text-xl font-bold text-green-400">+10%</div>
                                <div class="text-xs text-gray-400">Bonus</div>
                            </div>
                        </div>
                        <button onclick="claimBonus()" class="w-full mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            üéÅ T√§glichen Bonus abholen
                        </button>
                    </div>
                `;
            }
        }

        // claimDailyBonus function is now provided by bonus-functions.js

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéÅ Bonus System geladen');
            initializeBonusSystem();
            
            // Initialize auth state listener
            if (auth) {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        console.log('üë§ User logged in, loading profile...');
                        window.currentUser = user;
                        
                        // Load user profile
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            if (userDoc.exists) {
                                window.userProfile = userDoc.data();
                                console.log('‚úÖ User profile loaded:', window.userProfile);
                                
                                // Update bonus display
                                if (typeof window.updateBonusDisplay === 'function') {
                                    window.updateBonusDisplay();
                                }
                            } else {
                                console.log('‚ùå User profile not found in Firestore');
                            }
                        } catch (error) {
                            console.error('‚ùå Error loading user profile:', error);
                        }
                    } else {
                        console.log('‚ùå User not logged in');
                        window.currentUser = null;
                        window.userProfile = null;
                    }
                });
            }
        });
    </script>
</body>
</html>