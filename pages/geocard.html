<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoCard - GeoDrop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="../config/config-secure.js"></script>
    <script src="../config/config-secrets-public.js"></script>
    <script src="../js/firebase.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/dev-functions.js"></script>
    <script src="../js/upload-functions.js"></script>
    <script src="../js/geocard.js"></script>
    <script src="../js/user-drop-functions.js"></script>
    
    <!-- Dev Functions -->
    <script>
        // DEV FUNCTION - Fix any drop creator name
        window.devFixDropCreator = async function(dropNumber, newCreatorName) {
            console.log(`üîß DEV: Fixing Drop ${dropNumber} creator to: ${newCreatorName}`);
            
            // Check multiple dev login indicators
            const isDevLoggedIn = window.isDevLoggedIn || 
                                 sessionStorage.getItem('devLoggedIn') === 'true' ||
                                 window.isAdmin === true;
            
            if (!isDevLoggedIn) {
                alert('‚ùå Dev-Zugang erforderlich! Bitte zuerst als Dev anmelden.');
                return;
            }
            
            try {
                const db = window.firebase.firestore();
                const collections = ['userDrops', 'devDrops'];
                let found = false;
                
                for (const collectionName of collections) {
                    console.log(`üîç Searching in ${collectionName}...`);
                    const snapshot = await db.collection(collectionName).get();
                    
                    for (const doc of snapshot.docs) {
                        const data = doc.data();
                        if (data.geodropNumber === dropNumber.toString() || data.geodropNumber === dropNumber) {
                            console.log(`üìÑ Found Drop ${dropNumber} in ${collectionName}:`, doc.id);
                            console.log('üìä Current data:', data);
                            
                            // Update the document
                            await doc.ref.update({
                                createdByName: newCreatorName,
                                createdBy: 'dev-admin'
                            });
                            
                            console.log(`‚úÖ Drop ${dropNumber} updated successfully!`);
                            found = true;
                            break;
                        }
                    }
                    
                    if (found) break;
                }
                
                if (found) {
                    alert(`‚úÖ Drop ${dropNumber} Ersteller wurde auf "${newCreatorName}" ge√§ndert!`);
                    // Force reload
                    setTimeout(() => {
                        if (typeof loadGeoDrops === 'function') {
                            loadGeoDrops();
                        }
                        if (typeof loadUserGeoDrops === 'function') {
                            loadUserGeoDrops();
                        }
                    }, 1000);
                } else {
                    alert(`‚ùå Drop ${dropNumber} nicht gefunden!`);
                }
                
            } catch (error) {
                console.error('‚ùå Error fixing drop:', error);
                alert('‚ùå Fehler: ' + error.message);
            }
        };
        
        // SIMPLE DEV FUNCTION - No login check
        window.simpleFixDrop11 = async function() {
            console.log('üîß SIMPLE: Fixing Drop 11 to KryptoGuru');
            
            try {
                const db = window.firebase.firestore();
                const collections = ['userDrops', 'devDrops'];
                let found = false;
                
                for (const collectionName of collections) {
                    console.log(`üîç Searching in ${collectionName}...`);
                    const snapshot = await db.collection(collectionName).get();
                    
                    for (const doc of snapshot.docs) {
                        const data = doc.data();
                        if (data.geodropNumber === '11' || data.geodropNumber === 11) {
                            console.log(`üìÑ Found Drop 11 in ${collectionName}:`, doc.id);
                            console.log('üìä Current data:', data);
                            
                            // Update the document
                            await doc.ref.update({
                                createdByName: 'KryptoGuru',
                                createdBy: 'dev-admin'
                            });
                            
                            console.log('‚úÖ Drop 11 updated successfully!');
                            found = true;
                            break;
                        }
                    }
                    
                    if (found) break;
                }
                
                if (found) {
                    alert('‚úÖ Drop 11 Ersteller wurde auf "KryptoGuru" ge√§ndert!');
                    // Force reload
                    setTimeout(() => {
                        if (typeof loadGeoDrops === 'function') {
                            loadGeoDrops();
                        }
                        if (typeof loadUserGeoDrops === 'function') {
                            loadUserGeoDrops();
                        }
                    }, 1000);
                } else {
                    alert('‚ùå Drop 11 nicht gefunden!');
                }
                
            } catch (error) {
                console.error('‚ùå Error fixing drop:', error);
                alert('‚ùå Fehler: ' + error.message);
            }
        };
    </script>
    
    <!-- Test Austria Drop Function -->
    <script>
        // Test function - Create Test Drop for Stift Melk
        window.createTestMelkDrop = async function() {
            console.log('üèõÔ∏è Creating TEST Stift Melk Drop...');
            
            if (!window.isDevLoggedIn && sessionStorage.getItem('devLoggedIn') !== 'true') {
                showMessage('‚ùå Dev-Zugang erforderlich!', true);
                return;
            }
            
            try {
                const db = window.firebase.firestore();
                
                // Download and upload reference image to Firebase Storage
                console.log('üì• Downloading reference image for Stift Melk...');
                
                let imageBlob;
                
                // Try to get Stift Melk image from Google Places API directly
                console.log('üì• Getting Stift Melk image from Google Places API...');
                try {
                    // First, find the correct Place ID for Stift Melk
                    const searchResponse = await fetch('/api/places/search?query=Stift Melk');
                    if (searchResponse.ok) {
                        const searchData = await searchResponse.json();
                        if (searchData.results && searchData.results.length > 0) {
                            const placeId = searchData.results[0].place_id;
                            console.log('üìç Found Stift Melk Place ID:', placeId);
                            
                            // Now get the details and photos
                            const placeResponse = await fetch(`/api/places/details/${placeId}`);
                            if (placeResponse.ok) {
                                const placeData = await placeResponse.json();
                                if (placeData.result.photos && placeData.result.photos.length > 0) {
                                    const photoRef = placeData.result.photos[0].photo_reference;
                                    const photoResponse = await fetch(`/api/places/photo/?photo_reference=${photoRef}&maxwidth=800`);
                                    if (photoResponse.ok) {
                                        imageBlob = await photoResponse.blob();
                                        console.log('‚úÖ Got real Stift Melk image from Google Places API');
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.log('‚ùå Could not get Google Places image:', error);
                }
                
        // Fallback to a good Stift Melk image if Google Places fails
        if (!imageBlob) {
            console.log('üì• Using fallback Stift Melk image...');
            try {
                // Try multiple reliable image sources for Stift Melk
                const imageUrls = [
                    'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=800&h=600&fit=crop&auto=format',
                    'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80'
                ];
                
                let imageLoaded = false;
                for (const url of imageUrls) {
                    try {
                        console.log(`üì• Trying image URL: ${url}`);
                        const imageResponse = await fetch(url, {
                            mode: 'cors',
                            headers: {
                                'Accept': 'image/*'
                            }
                        });
                        
                        if (imageResponse.ok) {
                            imageBlob = await imageResponse.blob();
                            console.log('‚úÖ Using fallback Stift Melk image from:', url);
                            imageLoaded = true;
                            break;
                        }
                    } catch (urlError) {
                        console.log(`‚ùå Failed to load image from ${url}:`, urlError);
                        continue;
                    }
                }
                
                if (!imageLoaded) {
                    throw new Error('All image sources failed');
                }
            } catch (error) {
                console.error('‚ùå Could not load any image:', error);
                showMessage('‚ùå Fehler beim Laden des Bildes - alle Quellen fehlgeschlagen', true);
                return;
            }
        }
                
                // Upload to Firebase Storage
                const storage = window.firebase.storage();
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`referenzbilder_userdrop/UserDrop1_StiftMelk.jpg`);
                
                console.log('üì§ Uploading reference image to Firebase Storage...');
                const uploadTask = await imageRef.put(imageBlob);
                const downloadURL = await uploadTask.ref.getDownloadURL();
                
                // Calculate hash for image comparison
                const arrayBuffer = await imageBlob.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const imageHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                console.log('üîê Reference image hash calculated:', imageHash);
                console.log('‚úÖ Reference image uploaded:', downloadURL);
                
                // Test drop - Stift Melk
                const testDrop = {
                    name: 'UserDrop1_StiftMelk',
                    description: 'üèõÔ∏è Stift Melk - Melk (TEST)',
                    photoDescription: 'Fotografiere das Stift Melk mit seiner barocken Architektur und dem pr√§chtigen Kloster. Das Stift sollte vollst√§ndig sichtbar sein.',
                    reward: 10,
                    lat: 48.22802251267518,
                    lng: 15.328281989202512,
                    createdBy: 'austria-tourist-system',
                    createdByName: 'Austria Tourist System',
                    createdAt: new Date(),
                    isActive: true,
                    isAvailable: true,
                    geodropNumber: '1',
                    collection: 'userDrops',
                    referenceImage: 'UserDrop1_StiftMelk.jpg',
                    referenceImageUrl: downloadURL,
                    referenceImageHash: imageHash,
                    isAustriaTouristDrop: true,
                    federalState: 'Nieder√∂sterreich',
                    placeName: 'Stift Melk',
                    placeAddress: 'Abt-Berthold-Dietmayr-Stra√üe 1, 3390 Melk, √ñsterreich'
                };
                
                await db.collection('userDrops').add(testDrop);
                
                console.log('‚úÖ Test Melk Drop created:', testDrop.name);
                showMessage('‚úÖ Test Melk Drop erfolgreich erstellt! (Stift Melk)', false);
                
                // Reload all drop lists
                console.log('üîÑ Reloading drop lists...');
                
                // Reload User Drops for Upload
                if (typeof loadUserDropsForUpload === 'function') {
                    await loadUserDropsForUpload();
                }
                
                // Reload User GeoDrops table
                if (typeof loadUserGeoDrops === 'function') {
                    await loadUserGeoDrops();
                }
                
                // Reload all GeoDrops for map
                if (typeof loadGeoDrops === 'function') {
                    await loadGeoDrops();
                }
                
                console.log('‚úÖ All drop lists reloaded');
                
            } catch (error) {
                console.error('‚ùå Error creating test Melk Drop:', error);
                showMessage('‚ùå Fehler beim Erstellen des Test Melk Drops: ' + error.message, true);
            }
        };

        // Test function - Create only ONE Austria Tourist Drop (directly in GeoCard)
        window.createTestAustriaDrop = async function() {
            console.log('üß™ Creating TEST Austria Tourist Drop...');
            
            if (!window.isDevLoggedIn && sessionStorage.getItem('devLoggedIn') !== 'true') {
                showMessage('‚ùå Dev-Zugang erforderlich!', true);
                return;
            }
            
            try {
                const db = window.firebase.firestore();
                
                // Download and upload reference image to Firebase Storage
                console.log('üì• Downloading reference image...');
                const imageResponse = await fetch('https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=800&h=600&fit=crop');
                const imageBlob = await imageResponse.blob();
                
                // Upload to Firebase Storage
                const storage = window.firebase.storage();
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`referenzbilder_userdrop/Schloss_Sch√∂nbrunn.jpg`);
                
                console.log('üì§ Uploading reference image to Firebase Storage...');
                const uploadTask = await imageRef.put(imageBlob);
                const downloadURL = await uploadTask.ref.getDownloadURL();
                
                // Calculate hash for image comparison
                const arrayBuffer = await imageBlob.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const imageHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                console.log('üîê Reference image hash calculated:', imageHash);
                console.log('‚úÖ Reference image uploaded:', downloadURL);
                
                // Test drop - Schloss Sch√∂nbrunn in Wien
                const testDrop = {
                    name: 'Austria-Wien-Test-1',
                    description: 'üá¶üáπ Schloss Sch√∂nbrunn - Wien (TEST)',
                    photoDescription: 'Fotografiere das Schloss Sch√∂nbrunn mit seiner barocken Fassade und den pr√§chtigen G√§rten. Das Schloss sollte vollst√§ndig sichtbar sein.',
                    reward: 10,
                    lat: 48.1833,
                    lng: 16.3167,
                    createdBy: 'austria-tourist-system',
                    createdByName: 'Austria Tourist System',
                    createdAt: new Date(),
                    isActive: true,
                    isAvailable: true,
                    geodropNumber: '1',
                    collection: 'userDrops',
                    referenceImage: 'Schloss_Sch√∂nbrunn.jpg',
                    referenceImageUrl: downloadURL, // Firebase Storage URL
                    referenceImageHash: imageHash, // SHA-256 hash for comparison
                    isAustriaTouristDrop: true,
                    federalState: 'Wien'
                };
                
                await db.collection('userDrops').add(testDrop);
                
                console.log('‚úÖ Test Austria Drop created:', testDrop.name);
                showMessage('‚úÖ Test Austria Drop erfolgreich erstellt! (Schloss Sch√∂nbrunn)', false);
                
                // Reload drops if function exists
                if (typeof loadAllUserDrops === 'function') {
                    loadAllUserDrops();
                }
                
            } catch (error) {
                console.error('‚ùå Error creating test Austria Drop:', error);
                showMessage('‚ùå Fehler beim Erstellen des Test Austria Drops: ' + error.message, true);
            }
        };
    </script>
    
    <!-- Firebase SDK wird bereits in firebase.js geladen -->
    <style>
        #mapid {
            height: 400px;
            width: 100%;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .user-marker {
            font-size: 24px;
            text-align: center;
            line-height: 30px;
        }
        
        .drop-marker {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .drop-marker:hover {
            transform: scale(1.2);
        }
        
        .dev-drop-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        .dev-drop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        .dev-drop-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="max-w-6xl mx-auto p-6">
        <h2 class="text-3xl font-bold text-white mb-8">
            <span style="background: rgba(0, 0, 0, 0.7); padding: 8px 12px; border-radius: 8px; display: inline-block;">üó∫Ô∏è GeoCard</span>
        </h2>
        
        <!-- Map Container -->
        <div class="bg-gray-700 rounded-lg p-6 mb-6">
            <h3 class="text-xl font-semibold text-white mb-4">üåç Interaktive Karte</h3>
            <div id="mapid"></div>
            
            <!-- Map Legend and User Drop Creation Buttons -->
            <div class="mt-4 text-center space-x-3">
                <button onclick="showMapLegendPopup()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    üó∫Ô∏è Karten-Legende anzeigen
                </button>
                <button onclick="showCreateUserDropModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    ‚ûï User Drop erstellen
                </button>
            </div>
        </div>
        
        <!-- Location & Photo Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-700 rounded-lg p-6">
                <h3 class="text-xl font-semibold text-white mb-4">üìç Standort</h3>
                <button onclick="getUserLocation()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors mb-4">
                    üìç Meinen Standort verwenden
                </button>
                <div id="location-info" class="text-sm text-gray-300">
                    <p>Klicke auf den Button um deine aktuelle Position zu laden</p>
                </div>
            </div>
            
            <div class="bg-gray-700 rounded-lg p-6">
                <h3 class="text-xl font-semibold text-white mb-4">üì∏ Foto-Upload</h3>
                
                <!-- Drop Selection -->
                <div class="mb-4">
                    <label for="geocard-drop-select" class="block text-sm font-medium text-gray-300 mb-2">
                        GeoDrop ausw√§hlen:
                    </label>
                
                <!-- Upload List Type Toggle -->
                <div class="mb-3">
                    <div class="flex bg-gray-600 rounded-lg p-1">
                        <button id="upload-dev-drops-btn" onclick="switchToUploadListType('dev')" class="flex-1 px-3 py-1 rounded-md text-xs font-medium transition-colors bg-blue-600 text-white">
                            üéØ Dev Drops
                        </button>
                        <button id="upload-user-drops-btn" onclick="switchToUploadListType('user')" class="flex-1 px-3 py-1 rounded-md text-xs font-medium transition-colors text-gray-300 hover:text-white">
                            üë§ User Drops
                        </button>
                    </div>
                </div>
                
                <!-- Dev Drops Select -->
                <div id="upload-dev-drops-section">
                    <select id="geocard-drop-select" class="w-full p-3 bg-gray-600 border border-gray-500 rounded text-white" onchange="updateClaimButton()">
                        <option value="">Dev GeoDrop ausw√§hlen...</option>
                        <option value="devDrops:dev1">üéØ Dev GeoDrop1 - 100 PixelDrops</option>
                        <option value="devDrops:dev2">üéØ Dev GeoDrop2 - 100 PixelDrops</option>
                        <option value="devDrops:dev3">üéØ Dev GeoDrop3 - 100 PixelDrops</option>
                        <option value="devDrops:dev4">üéØ Dev GeoDrop4 - 100 PixelDrops</option>
                        <option value="devDrops:dev5">üéØ Dev GeoDrop5 - 100 PixelDrops</option>
                        <option value="devDrops:dev6">üéØ Dev GeoDrop6 - 100 PixelDrops</option>
                        <option value="devDrops:dev7">üéØ Dev GeoDrop7 - 100 PixelDrops</option>
                        <option value="devDrops:dev8">üéØ Dev GeoDrop8 - 100 PixelDrops</option>
                    </select>
                </div>
                
                <!-- User Drops Select -->
                <div id="upload-user-drops-section" style="display: none;">
                    <select id="geocard-user-drop-select" class="w-full p-3 bg-gray-600 border border-gray-500 rounded text-white" onchange="updateClaimButton()">
                        <option value="">Lade User GeoDrops...</option>
                    </select>
                </div>
                
                    <!-- Hidden input for drop ID -->
                    <input type="hidden" id="selected-drop-id" value="">
                </div>
                
                <!-- Dev Coordinates Input (nur f√ºr Dev-User) -->
                <div id="dev-drop-selection" class="mb-4 p-3 bg-yellow-900 border border-yellow-600 rounded" style="display: none;">
                    <label class="block text-sm font-medium text-yellow-300 mb-2 font-bold">
                        üîß DEV: Test-Koordinaten eingeben:
                    </label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label for="dev-test-lat" class="block text-xs text-yellow-300 mb-1">Breitengrad:</label>
                            <input type="number" id="dev-test-lat" step="0.000001" placeholder="52.123456" class="w-full p-2 bg-gray-600 border border-yellow-500 rounded text-white text-sm" onkeypress="if(event.key === 'Enter') setDevTestCoordinates()">
                        </div>
                        <div>
                            <label for="dev-test-lng" class="block text-xs text-yellow-300 mb-1">L√§ngengrad:</label>
                            <input type="number" id="dev-test-lng" step="0.000001" placeholder="13.123456" class="w-full p-2 bg-gray-600 border border-yellow-500 rounded text-white text-sm" onkeypress="if(event.key === 'Enter') setDevTestCoordinates()">
                        </div>
                    </div>
                    <button onclick="setDevTestCoordinates()" class="w-full px-3 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm">
                        üìç Test-Koordinaten setzen
                    </button>
                    <p class="text-yellow-300 text-sm mt-1">‚ö†Ô∏è Nur f√ºr Dev-Tests - normale User sehen dies nicht!</p>
                    
                    <!-- Test Drop Buttons -->
                    <div class="mt-3 space-y-2">
                        <button onclick="createTestMelkDrop()" class="w-full px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">
                            üèõÔ∏è Test-Drop: Stift Melk erstellen
                        </button>
                        <button onclick="createTestAustriaDrop()" class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            üè∞ Test-Drop: Schloss Sch√∂nbrunn erstellen
                        </button>
                        <button onclick="createAllAustrianStateDrops()" class="w-full px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">
                            üá¶üáπ Alle 9 Bundesl√§nder-Drops erstellen
                        </button>
                        <button onclick="createRemainingAustrianDrops()" class="w-full px-3 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm">
                            üöÄ Restliche 8 Bundesl√§nder-Drops erstellen
                        </button>
                        <button onclick="reloadAllDropLists()" class="w-full px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                            üîÑ Alle Listen neu laden
                        </button>
                        <button onclick="clearUserDropLists()" class="w-full px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                            üßπ User Drop Listen leeren
                        </button>
                        <button onclick="restoreUserDropLists()" class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            üîÑ User Drop Listen wiederherstellen
                        </button>
                        <button onclick="checkUserDropCount()" class="w-full px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">
                            üìä User Drop Anzahl pr√ºfen
                        </button>
                        <button onclick="cleanupDuplicateUserDrops()" class="w-full px-3 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm">
                            üßπ Duplikate bereinigen
                        </button>
                        <button onclick="createMissingDrop1()" class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            üèõÔ∏è Drop Nr. 1 (Stift Melk) erstellen
                        </button>
                    </div>
                </div>
                
                <input type="file" id="photo-input" accept="image/*" capture="environment" class="hidden" onchange="handlePhotoFileSelect()">
                <button onclick="handlePhotoCapture()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors mb-4">
                    üì∏ Foto aufnehmen
                </button>
                
                <!-- Dev-only: Bild ausw√§hlen Button -->
                <button id="dev-select-image-btn" onclick="handleDevImageSelect()" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors mb-4" style="display: none;">
                    üñºÔ∏è Bild ausw√§hlen (Dev)
                </button>
                
                <!-- Debug Button -->
                <button onclick="debugUploadProcess()" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors mb-4">
                    üîç Upload Debug
                </button>
                
                <div id="photo-preview" class="mt-4"></div>
            </div>
        </div>
        
        <!-- Dev Coordinate Adjustment Section -->
        <div class="bg-gray-700 rounded-lg p-6 mt-6">
            <h3 class="text-xl font-semibold text-white mb-4">üéØ Dev Koordinaten-Anpassung</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Breitengrad (Lat)</label>
                        <input type="number" id="dev-lat-input" step="0.000001" class="w-full px-3 py-2 bg-gray-600 text-white rounded-lg border border-gray-500 focus:border-blue-500 focus:outline-none" placeholder="z.B. 52.520008">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">L√§ngengrad (Lng)</label>
                        <input type="number" id="dev-lng-input" step="0.000001" class="w-full px-3 py-2 bg-gray-600 text-white rounded-lg border border-gray-500 focus:border-blue-500 focus:outline-none" placeholder="z.B. 13.404954">
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button id="dev-coords-btn" class="dev-drop-btn flex-1" onclick="setDevCoordinates()" disabled>
                    üîí Admin-Modus erforderlich
                </button>
                    <button onclick="resetToCurrentLocation()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-colors">
                        üìç Aktuelle Position
                </button>
        </div>
            <div class="text-sm text-gray-400">
                <p>Admin-Status: <span id="admin-status">Inaktiv (nur mit Admin-Passwort)</span></p>
                    <p>Dev-Koordinaten: <span id="dev-coords-status">Nicht gesetzt</span></p>
                </div>
                <div class="mt-4" id="dev-session-section" style="display: none;">
                    <button onclick="endDevSession()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                        üîí Dev-Session beenden
                    </button>
                </div>
            </div>
        </div>
        
        <!-- GeoDrops Table -->
        <div class="bg-gray-700 rounded-lg p-6 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">üìã GeoDrops √úbersicht</h3>
                <div class="flex gap-2">
                    <button onclick="reloadAllDropLists()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        üîÑ Drops neu laden
                    </button>
                </div>
            </div>
            
            <!-- List Type Toggle -->
            <div class="mb-6">
                <div class="flex bg-gray-600 rounded-lg p-1">
                    <button id="dev-drops-btn" onclick="switchToListType('dev')" class="flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors bg-blue-600 text-white">
                        üéØ Dev GeoDrops
                    </button>
                    <button id="user-drops-btn" onclick="switchToListType('user')" class="flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-300 hover:text-white">
                        üë§ User GeoDrops
                    </button>
                </div>
            </div>
            
            <!-- Dev GeoDrops Table -->
            <div id="dev-drops-section" style="display: block;">
                <div id="geodrops-table" class="mt-4">
                    <div class="text-center text-gray-400 py-4">
                        <p>Lade Dev GeoDrops-Tabelle...</p>
                    </div>
                </div>
            </div>
            
            <script>
                // Load dev drops table immediately when page loads
                document.addEventListener('DOMContentLoaded', function() {
                    // Force show dev drops section immediately
                    const devSection = document.getElementById('dev-drops-section');
                    const userSection = document.getElementById('user-drops-section');
                    if (devSection && userSection) {
                        devSection.style.display = 'block';
                        userSection.style.display = 'none';
                        console.log('‚úÖ HTML: Forced dev drops section to be visible');
                    }
                    
                    // Load immediately
                    if (typeof window.loadDevGeoDrops === 'function') {
                        console.log('üîÑ Auto-loading Dev GeoDrops table...');
                        window.loadDevGeoDrops();
                    }
                    
                    // KOPIERTE L√ñSUNG: Auch Upload-Liste sofort laden
                    if (typeof window.loadDevDropsForUpload === 'function') {
                        console.log('üîÑ Auto-loading Dev Drops for Upload...');
                        window.loadDevDropsForUpload();
                    }
                    
                    // Upload-Sektion sofort anzeigen
                    const uploadDevSection = document.getElementById('upload-dev-drops-section');
                    const uploadUserSection = document.getElementById('upload-user-drops-section');
                    if (uploadDevSection && uploadUserSection) {
                        uploadDevSection.style.display = 'block';
                        uploadUserSection.style.display = 'none';
                        console.log('‚úÖ Upload dev section shown immediately');
                    }
                    
                    // Firebase is already ready, no delay needed
                });
            </script>
            
            <!-- User GeoDrops Table -->
            <div id="user-drops-section" style="display: none;">
                <div id="user-drops-table" class="mt-4">
                    <div class="text-center text-gray-400 py-4">
                        <p>Lade User GeoDrops-Tabelle...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create User Drop Modal -->
    <div id="create-user-drop-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; overflow-y: auto;">
        <div style="display: flex; align-items: flex-start; justify-content: center; min-height: 100vh; padding: 2px;">
            <div style="background: #374151; border-radius: 8px; max-width: 600px; width: 100%; padding: 12px; max-height: 99vh; overflow-y: auto; margin-top: 5px; margin-bottom: 5px;">
                <h2 style="color: white; font-size: 20px; font-weight: bold; margin-bottom: 12px; text-align: center;">‚ûï User GeoDrop erstellen</h2>
                
                <div style="space-y: 16px;">
                    <!-- Drop Name -->
                    <div>
                        <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üéØ Drop Name:</label>
                        <input type="text" id="user-drop-name" placeholder="z.B. Historisches Geb√§ude" style="width: 100%; padding: 10px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 14px;">
                    </div>
                    
                    <!-- Photo Description -->
                    <div>
                        <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üì∏ Was soll fotografiert werden:</label>
                        <textarea id="user-drop-description" placeholder="Beschreibe genau, was an diesem Standort fotografiert werden soll..." style="width: 100%; padding: 10px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 14px; height: 70px; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- Reference Image Upload -->
                    <div>
                        <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üñºÔ∏è Referenzbild hochladen:</label>
                        <input type="file" id="user-drop-reference-image" accept="image/*" style="width: 100%; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px;">
                        <p style="color: #9CA3AF; font-size: 12px; margin-top: 4px;">Lade ein Referenzbild hoch, das zeigt was fotografiert werden soll</p>
                        <div id="user-drop-image-preview" style="margin-top: 8px; display: none;">
                            <img id="user-drop-preview-img" style="max-width: 200px; max-height: 150px; border-radius: 6px; border: 1px solid #6B7280;">
                        </div>
                    </div>
                    
                    <!-- Reward -->
                    <div>
                        <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üí∞ Belohnung (PixelDrops):</label>
                        <input type="number" id="user-drop-reward" value="10" min="10" max="10" readonly style="width: 100%; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px;">
                        <p style="color: #9CA3AF; font-size: 12px; margin-top: 4px;">User Drops sind auf 10 PixelDrops fixiert</p>
                    </div>
                    
                    <!-- Current Location -->
                    <div>
                        <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üìç Standort:</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" id="user-drop-lat" step="0.000001" placeholder="Breitengrad" readonly style="flex: 1; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px;">
                            <input type="number" id="user-drop-lng" step="0.000001" placeholder="L√§ngengrad" readonly style="flex: 1; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px;">
                        </div>
                        <button onclick="useCurrentLocationForUserDrop()" style="margin-top: 8px; padding: 8px 16px; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            üìç Aktuelle Position verwenden
                        </button>
                        <p style="color: #9CA3AF; font-size: 12px; margin-top: 4px;">Standort wird automatisch von deiner aktuellen Position √ºbernommen</p>
                    </div>
                    
                    <!-- Dev Coordinates (only for Dev users) -->
                    <div id="dev-coordinates-section" style="display: none;">
                        <label style="color: #FBBF24; font-weight: bold; margin-bottom: 8px; display: block;">üîß DEV: Test-Koordinaten:</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" id="dev-user-drop-lat" step="0.000001" placeholder="Dev Breitengrad" style="flex: 1; padding: 12px; background: #4B5563; border: 1px solid #FBBF24; border-radius: 6px; color: white; font-size: 16px;">
                            <input type="number" id="dev-user-drop-lng" step="0.000001" placeholder="Dev L√§ngengrad" style="flex: 1; padding: 12px; background: #4B5563; border: 1px solid #FBBF24; border-radius: 6px; color: white; font-size: 16px;">
                        </div>
                        <p style="color: #FBBF24; font-size: 12px; margin-top: 4px;">‚ö†Ô∏è Nur f√ºr Dev-Tests - normale User sehen dies nicht!</p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 16px; margin-bottom: 20px; padding-bottom: 10px;">
                    <button onclick="createUserDrop()" style="flex: 1; padding: 12px; background: #10B981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; min-height: 48px;">
                        ‚úÖ User Drop erstellen
                    </button>
                    <button onclick="closeCreateUserDropModal()" style="flex: 1; padding: 12px; background: #6B7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; min-height: 48px;">
                        ‚ùå Abbrechen
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Map Legend Popup -->
    <div id="map-legend-popup" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; overflow-y: auto;">
        <div style="display: flex; align-items: flex-start; justify-content: center; min-height: 100vh; padding: 5px;">
            <div style="background: #374151; border-radius: 8px; max-width: 500px; width: 100%; padding: 16px; max-height: 98vh; overflow-y: auto; margin-top: 10px; margin-bottom: 10px;">
                <h2 style="color: white; font-size: 20px; font-weight: bold; margin-bottom: 12px; text-align: center;">üó∫Ô∏è Karten-Legende</h2>
                <div style="space-y: 12px;">
                    <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; background: #4B5563; border-radius: 6px;">
                        <span style="font-size: 24px; margin-right: 12px;">üìç</span>
                        <div>
                            <div style="color: white; font-weight: bold;">Dein Standort</div>
                            <div style="color: #9CA3AF; font-size: 14px;">Deine aktuelle GPS-Position</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; background: #4B5563; border-radius: 6px;">
                        <span style="font-size: 20px; margin-right: 12px;">üéØ</span>
                        <div>
                            <div style="color: white; font-weight: bold;">Normale GeoDrops</div>
                            <div style="color: #9CA3AF; font-size: 14px;">Kleine Dart-Scheibe - Offizielle GeoDrops</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; background: #4B5563; border-radius: 6px;">
                        <span style="font-size: 24px; margin-right: 12px;">üë§</span>
                        <div>
                            <div style="color: white; font-weight: bold;">User GeoDrops</div>
                            <div style="color: #9CA3AF; font-size: 14px;">Mittlere Gr√∂√üe - Von Spielern erstellte GeoDrops</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; background: #4B5563; border-radius: 6px;">
                        <span style="font-size: 28px; margin-right: 12px;">üéØ</span>
                        <div>
                            <div style="color: white; font-weight: bold;">Dev GeoDrop</div>
                            <div style="color: #9CA3AF; font-size: 14px;">Gr√∂√üere Dart-Scheibe (2.5x gr√∂√üer) - Entwickler-Test-Drops</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 12px; padding: 8px; background: #4B5563; border-radius: 6px;">
                        <span style="font-size: 24px; margin-right: 12px; filter: grayscale(100%) opacity(0.5);">üéØ</span>
                        <div>
                            <div style="color: white; font-weight: bold;">Heute gesammelt</div>
                            <div style="color: #9CA3AF; font-size: 14px;">Graue Dart-Scheibe - Heute bereits gesammelt</div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="closeMapLegendPopup()" style="background: #6B7280; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">Schlie√üen</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Config from global CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBbaHV1OY9C_MUt4o3WTkHCGlRVt7ll9UA",
            authDomain: "geodrop-f3ee1.firebaseapp.com",
            projectId: "geodrop-f3ee1",
            storageBucket: "geodrop-f3ee1.firebasestorage.app",
            messagingSenderId: "1054615552034",
            appId: "1:1054615552034:web:8d61c64b5296f4e0cc4a7b",
            measurementId: "G-RBEJES6HX1"
        };

        // Initialize Firebase - NUR wenn noch nicht initialisiert
        let app, db, storage, auth;
        
        try {
            // Pr√ºfen ob Firebase bereits initialisiert ist
            if (firebase.apps.length === 0) {
                app = firebase.initializeApp(firebaseConfig);
                console.log("‚úÖ Firebase initialized successfully in GeoCard");
            } else {
                app = firebase.app();
                console.log("‚úÖ Firebase already initialized, using existing app");
            }
            
            db = firebase.firestore();
            storage = firebase.storage();
            auth = firebase.auth();
        } catch (error) {
            console.error("‚ùå Firebase initialization failed in GeoCard:", error);
        }
        
        // Make Firebase services globally available - NUR wenn noch nicht gesetzt
        if (!window.auth) window.auth = auth;
        if (!window.db) window.db = db;
        if (!window.storage) window.storage = storage;
        if (!window.firebase) window.firebase = firebase;

        // Global variables for GeoCard
        let map;
        let userMarker;
        let dropMarkers = [];
        let currentUser = null;
        let userProfile = null;
        let username = 'KryptoGuru'; // Default username
        
        // Initialize GeoCard when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üó∫Ô∏è GeoCard page loaded, initializing...');
            
            // Check Dev status from sessionStorage first
            const savedDevStatus = sessionStorage.getItem('devLoggedIn');
            const savedDevTimestamp = sessionStorage.getItem('devLoginTimestamp');
            const currentTime = Date.now();
            const sessionTimeout = 2 * 60 * 60 * 1000; // 2 hours
            
            if (savedDevStatus === 'true' && savedDevTimestamp) {
                const timeDiff = currentTime - parseInt(savedDevTimestamp);
                if (timeDiff < sessionTimeout) {
                    console.log('üîì Valid dev session found - restoring');
                    window.isDevLoggedIn = true;
                    window.isAdmin = true;
                    window.isDevLoggedIn = true;
                    console.log('üîì Dev status: restored from session');
                } else {
                    console.log('‚è∞ Dev session expired - removing');
                    localStorage.removeItem('devLoggedIn');
                    localStorage.removeItem('devLoginTimestamp');
                    window.isDevLoggedIn = false;
                    window.isAdmin = false;
                }
            } else {
                window.isDevLoggedIn = false;
                window.isAdmin = false;
            }
            
            // Initialize Dev status
            if (typeof window.initializeDevStatus === 'function') {
                await window.initializeDevStatus();
            }
            
            initializeGeoCard();
            
            // Initialize upload list type
            window.currentUploadListType = 'dev';
            
            // KOPIERTE L√ñSUNG: Genau wie die funktionierende Liste unten
            console.log('üîÑ Auto-loading Dev Drops for Upload...');
            
            // Load immediately - GENAU WIE DIE FUNKTIONIERENDE LISTE
            if (typeof window.loadDevDropsForUpload === 'function') {
                console.log('üîÑ Auto-loading Dev Drops for Upload...');
                window.loadDevDropsForUpload();
            } else {
                console.log('‚ùå loadDevDropsForUpload function not available yet');
            }
            
            // Zus√§tzliche Sicherheit: Direkter Aufruf nach kurzer Verz√∂gerung
            setTimeout(() => {
                console.log('üîÑ Retry: Loading Dev Drops for Upload...');
                if (typeof window.loadDevDropsForUpload === 'function') {
                    window.loadDevDropsForUpload();
                } else {
                    console.log('‚ùå loadDevDropsForUpload function still not available');
                }
            }, 1000);
            // Load dev drops table by default
            if (typeof window.loadDevGeoDrops === 'function') {
                window.loadDevGeoDrops();
            }
            
            // Load all user drops
            if (typeof window.loadAllUserDrops === 'function') {
                console.log('üîÑ Loading all user drops...');
                window.loadAllUserDrops();
            }
            
            // Ensure current list type is set
            window.currentListType = 'dev';
            
            // Show dev drops section and table immediately
            const devSection = document.getElementById('dev-drops-section');
            const userSection = document.getElementById('user-drops-section');
            const devDropsTable = document.getElementById('dev-drops-table');
            const userDropsTable = document.getElementById('user-drops-table');
            
            if (devSection && userSection) {
                devSection.style.display = 'block';
                userSection.style.display = 'none';
                console.log('‚úÖ Dev drops section shown immediately');
            }
            
            if (devDropsTable && userDropsTable) {
                devDropsTable.style.display = 'block';
                userDropsTable.style.display = 'none';
                console.log('‚úÖ Dev drops table shown immediately');
            }
            
            // Load upload dropdown immediately
            if (typeof window.loadDevDropsForUpload === 'function') {
                console.log('üîÑ Calling loadDevDropsForUpload immediately...');
                window.loadDevDropsForUpload();
            } else {
                console.log('‚ùå loadDevDropsForUpload function not available');
            }
            
            // Upload-Sektion anzeigen - GENAU WIE DIE FUNKTIONIERENDE LISTE
            const uploadDevSection = document.getElementById('upload-dev-drops-section');
            const uploadUserSection = document.getElementById('upload-user-drops-section');
            if (uploadDevSection && uploadUserSection) {
                uploadDevSection.style.display = 'block';
                uploadUserSection.style.display = 'none';
                console.log('‚úÖ Upload dev section shown immediately');
            }
            
            // Force load upload dropdown after Firebase is ready
            setTimeout(() => {
                if (typeof window.loadDevDropsForUpload === 'function') {
                    console.log('üîÑ Force loading upload dropdown after Firebase ready...');
                    window.loadDevDropsForUpload();
                } else {
                    console.log('‚ùå loadDevDropsForUpload function not available in timeout');
                }
            }, 2000);
            
            // Show dev drops section immediately
            const devSectionFinal = document.getElementById('dev-drops-section');
            const userSectionFinal = document.getElementById('user-drops-section');
            if (devSectionFinal && userSectionFinal) {
                devSectionFinal.style.display = 'block';
                userSectionFinal.style.display = 'none';
                console.log('‚úÖ Dev drops section shown immediately');
            }
        });
        
        // Initialize GeoCard
        function initializeGeoCard() {
            console.log('üó∫Ô∏è Initializing GeoCard...');
            
            // Initialize map
            initializeMap();
            
            // Get user location immediately
            console.log('üó∫Ô∏è Getting user location...');
            getUserLocation();
            
            // Update dev drop button immediately
            console.log('üó∫Ô∏è Updating dev drop button...');
            updateDevDropButton();
        }
        
        // Map functions
        function initializeMap() {
            if (map) return;
            
            console.log('üó∫Ô∏è Creating map...');
            // Initialize map with a neutral view (world view)
            map = L.map('mapid').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            console.log('üó∫Ô∏è Map initialized');
        }
        
        // Last known location storage
        function saveLastKnownLocation(lat, lng, accuracy) {
            const locationData = {
                lat: lat,
                lng: lng,
                accuracy: accuracy,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('geodrop_last_location', JSON.stringify(locationData));
            console.log('üíæ Last known location saved:', locationData);
        }
        
        function getLastKnownLocation() {
            try {
                const saved = localStorage.getItem('geodrop_last_location');
                if (saved) {
                    const locationData = JSON.parse(saved);
                    const savedTime = new Date(locationData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - savedTime) / (1000 * 60 * 60);
                    
                    // Use saved location if it's less than 24 hours old
                    if (hoursDiff < 24) {
                        console.log('üìç Using last known location:', locationData);
                        return locationData;
                    } else {
                        console.log('‚è∞ Last known location too old, ignoring');
                        localStorage.removeItem('geodrop_last_location');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error reading last known location:', error);
                localStorage.removeItem('geodrop_last_location');
            }
            return null;
        }
        
        function useLastKnownLocation() {
            const lastLocation = getLastKnownLocation();
            if (lastLocation) {
                console.log('üìç Using last known location as fallback');
                
                // Update map view to last known location
                map.setView([lastLocation.lat, lastLocation.lng], 16);
                console.log(`üó∫Ô∏è Map view updated to last known: ${lastLocation.lat}, ${lastLocation.lng}`);
                
                // Add or update user marker
                if (userMarker) {
                    userMarker.setLatLng([lastLocation.lat, lastLocation.lng]);
                    console.log('üìç User marker updated to last known location');
                } else {
                    userMarker = L.marker([lastLocation.lat, lastLocation.lng], {
                        icon: L.divIcon({
                            className: 'user-marker',
                            html: 'üìç',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);
                    console.log('üìç New user marker created for last known location');
                }
                
                // Update location info
                const locationInfo = document.getElementById('location-info');
                if (locationInfo) {
                    const savedTime = new Date(lastLocation.timestamp);
                    locationInfo.innerHTML = `
                        <p><strong>Breitengrad:</strong> ${lastLocation.lat.toFixed(6)}</p>
                        <p><strong>L√§ngengrad:</strong> ${lastLocation.lng.toFixed(6)}</p>
                        <p><strong>Genauigkeit:</strong> ¬±${Math.round(lastLocation.accuracy)}m</p>
                        <p class="text-yellow-400"><strong>‚ö†Ô∏è Letzter bekannter Standort</strong></p>
                        <p class="text-sm text-gray-400">Gespeichert: ${savedTime.toLocaleString()}</p>
                    `;
                    console.log('üìç Location info updated with last known location');
                }
                
                showMessage('üìç Letzter bekannter Standort verwendet');
                return true;
            }
            return false;
        }

        function getUserLocation() {
            console.log('üìç getUserLocation() called');
            
            if (!map) {
                console.log('‚ùå Map not available, showing message');
                showMessage('Karte wird initialisiert...', true);
                return;
            }
            
            console.log('‚úÖ Map available, checking geolocation support');
            
            if (navigator.geolocation) {
                console.log('‚úÖ Geolocation supported, requesting position...');
                
                // Try to get high accuracy position with timeout
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000 // Use cached position if less than 1 minute old
                };
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        console.log(`üìç User location received: ${lat}, ${lng}`);
                        console.log(`üìç Accuracy: ${position.coords.accuracy}m`);
                        
                        // Save this location as last known
                        saveLastKnownLocation(lat, lng, position.coords.accuracy);
                        
                        // Update map view to user location
                        map.setView([lat, lng], 16);
                        console.log(`üó∫Ô∏è Map view updated to: ${lat}, ${lng}`);
                        
                        // Add or update user marker
                        if (userMarker) {
                            userMarker.setLatLng([lat, lng]);
                            console.log('üìç User marker updated');
                        } else {
                            userMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'user-marker',
                                    html: 'üìç',
                                    iconSize: [30, 30]
                                })
                            }).addTo(map);
                            console.log('üìç New user marker created and added to map');
                        }
                        
                        // Update location info
                        const locationInfo = document.getElementById('location-info');
                        if (locationInfo) {
                            locationInfo.innerHTML = `
                                <p><strong>Breitengrad:</strong> ${lat.toFixed(6)}</p>
                                <p><strong>L√§ngengrad:</strong> ${lng.toFixed(6)}</p>
                                <p><strong>Genauigkeit:</strong> ¬±${Math.round(position.coords.accuracy)}m</p>
                            `;
                            console.log('üìç Location info updated');
                        }
                        
                        console.log('‚úÖ User location successfully set!');
                        showMessage('Standort erfolgreich ermittelt!');
                    },
                    function(error) {
                        console.error('‚ùå Geolocation error:', error);
                        
                        // Try to use last known location first
                        if (useLastKnownLocation()) {
                            return; // Successfully used last known location
                        }
                        
                        // Show specific error message
                        let errorMessage = 'Fehler beim Ermitteln des Standorts: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Standort-Zugriff verweigert. Bitte erlaube den Standort-Zugriff in deinem Browser.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Standort-Information nicht verf√ºgbar.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Zeit√ºberschreitung beim Ermitteln des Standorts.';
                                break;
                            default:
                                errorMessage += error.message;
                        }
                        
                        showMessage(errorMessage, true);
                        
                        // Update location info with error
                        const locationInfo = document.getElementById('location-info');
                        if (locationInfo) {
                            locationInfo.innerHTML = `
                                <p class="text-red-400">‚ùå Standort konnte nicht ermittelt werden</p>
                                <p class="text-sm text-gray-400">Fehler: ${errorMessage}</p>
                                <p class="text-sm text-gray-400">Versuche es erneut oder pr√ºfe deine Browser-Einstellungen</p>
                            `;
                        }
                    },
                    options
                );
            } else {
                console.log('‚ùå Geolocation not supported');
                
                // Try to use last known location
                if (useLastKnownLocation()) {
                    return; // Successfully used last known location
                }
                
                showMessage('Geolocation wird nicht unterst√ºtzt.', true);
            }
        }
        
        // Real functions implementation
        function showMessage(message, isError = false) {
            console.log(isError ? '‚ùå' : '‚úÖ', message);
            // Use the global showMessage function if available
            if (typeof window.showMessage === 'function') {
                window.showMessage(message, isError);
            }
        }
        
        async function loadGeoDrops() {
            console.log('üó∫Ô∏è Loading GeoDrops...');
            try {
                if (!window.firebase || !window.firebase.firestore()) {
                    console.log('‚ùå Firebase not available');
                    return;
                }
                
                const db = window.firebase.firestore();
                
                // Load only devDrops and userDrops (no more "geodrops" collection)
                const devDropsSnapshot = await db.collection('devDrops').where('isAvailable', '==', true).get();
                const userDropsSnapshot = await db.collection('userDrops').where('isActive', '==', true).get();
                
                const allDrops = [];
                devDropsSnapshot.forEach(doc => {
                    allDrops.push({ id: doc.id, ...doc.data(), collection: 'devDrops', isDevDrop: true });
                });
                userDropsSnapshot.forEach(doc => {
                    allDrops.push({ id: doc.id, ...doc.data(), collection: 'userDrops', isDevDrop: false });
                });
                
                // NOTE: Dropdown update removed - it was overwriting the upload dropdown
                // The upload dropdown is managed by loadDevDropsForUpload() and loadUserDropsForUpload()
                
                // Add drop markers to map
                addDropMarkersToMap(allDrops);
                
                console.log(`‚úÖ Loaded ${allDrops.length} GeoDrops for map and dropdown`);
            } catch (error) {
                console.error('‚ùå Error loading GeoDrops:', error);
                showMessage('Fehler beim Laden der GeoDrops', true);
            }
        }
        
        // Add drop markers to map
        function addDropMarkersToMap(drops) {
            console.log(`üó∫Ô∏è Adding ${drops.length} drop markers to map`);
            
            // Clear existing drop markers
            dropMarkers.forEach(marker => {
                if (map && marker) {
                    map.removeLayer(marker);
                }
            });
            dropMarkers = [];
            
            // Add new markers
            drops.forEach(drop => {
                if (drop.lat && drop.lng && map) {
                    const isDevDrop = drop.isDevDrop || drop.collection === 'devDrops';
                    const markerIcon = L.divIcon({
                        className: 'drop-marker',
                        html: isDevDrop ? 'üéØ' : 'üéØ',
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    });
                    
                    const marker = L.marker([drop.lat, drop.lng], { icon: markerIcon })
                        .addTo(map)
                        .bindPopup(`
                            <div class="text-sm">
                                <strong>${isDevDrop ? 'üéØ Dev' : 'üåç'} GeoDrop${drop.geodropNumber || drop.id}</strong><br>
                                Reward: ${drop.reward || 100} PixelDrops<br>
                                Status: ${drop.isClaimed ? '‚ùå Gesammelt' : '‚úÖ Verf√ºgbar'}<br>
                                Koordinaten: ${drop.lat.toFixed(6)}, ${drop.lng.toFixed(6)}
                            </div>
                        `);
                    
                    dropMarkers.push(marker);
                }
            });
            
            console.log(`‚úÖ Added ${dropMarkers.length} markers to map`);
        }
        
        function updateDevDropButton() {
            console.log('üîß Updating dev drop button...');
            const devBtn = document.getElementById('dev-drop-btn');
            const adminBtn = document.getElementById('admin-toggle-btn');
            const adminStatus = document.getElementById('admin-status');
            const devSection = document.getElementById('dev-drop-selection');
            
            if (typeof window.isDevLoggedIn !== 'undefined' && window.isDevLoggedIn) {
                if (devBtn) {
                    devBtn.disabled = false;
                    devBtn.textContent = 'üéØ Dev Drop erstellen';
                }
                if (adminBtn) {
                    adminBtn.textContent = 'üîì Admin-Modus deaktivieren';
                    adminBtn.onclick = () => window.deauthorizeDev();
                }
                if (adminStatus) {
                    adminStatus.textContent = 'Aktiv';
                    adminStatus.className = 'text-green-400';
                }
                if (devSection) {
                    devSection.style.display = 'block';
                }
            } else {
                if (devBtn) {
                    devBtn.disabled = true;
                    devBtn.textContent = 'üîí Admin-Modus erforderlich';
                }
                if (adminBtn) {
                    adminBtn.textContent = 'üîì Admin-Modus aktivieren';
                    adminBtn.onclick = () => window.authorizeDev();
                }
                if (adminStatus) {
                    adminStatus.textContent = 'Inaktiv';
                    adminStatus.className = 'text-red-400';
                }
                if (devSection) {
                    devSection.style.display = 'none';
                }
            }
        }
        
        
        function setDevTestCoordinates() {
            console.log('üîß Setting dev test coordinates');
            const latInput = document.getElementById('dev-test-lat');
            const lngInput = document.getElementById('dev-test-lng');
            
            if (latInput && lngInput && latInput.value && lngInput.value) {
                const lat = parseFloat(latInput.value);
                const lng = parseFloat(lngInput.value);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    // Set global coordinates for testing
                    window.lastKnownLat = lat;
                    window.lastKnownLng = lng;
                    
                    // Update map view
                    if (map) {
                        map.setView([lat, lng], 16);
                    }
                    
                    showMessage(`üìç Test-Koordinaten gesetzt: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                    console.log(`üìç Dev test coordinates set: ${lat}, ${lng}`);
                } else {
                    showMessage('‚ùå Ung√ºltige Koordinaten!', true);
                }
            } else {
                showMessage('‚ùå Bitte beide Koordinaten eingeben!', true);
            }
        }
        
        function createDevDrop() {
            console.log('üéØ Creating dev drop');
            if (typeof window.createDevDrop === 'function') {
                window.createDevDrop();
            } else {
                showMessage('‚ùå Dev-Funktionen nicht verf√ºgbar', true);
            }
        }
        
        
        
        // Map Legend Popup Functions
        function showMapLegendPopup() {
            const popup = document.getElementById('map-legend-popup');
            if (popup) {
                popup.style.display = 'block';
            }
        }
        
        function closeMapLegendPopup() {
            const popup = document.getElementById('map-legend-popup');
            if (popup) {
                popup.style.display = 'none';
            }
        }
        
        // Close popup when clicking outside
        document.addEventListener('click', function(event) {
            const popup = document.getElementById('map-legend-popup');
            if (popup && event.target === popup) {
                closeMapLegendPopup();
            }
        });
        
        // List Type Switching Functions
        window.currentListType = 'dev'; // Track current list type
        window.currentUploadListType = 'dev'; // Track current upload list type

        window.switchToListType = function(type) {
            console.log(`üîÑ Switching to ${type} drops list`);
            
            const devBtn = document.getElementById('dev-drops-btn');
            const userBtn = document.getElementById('user-drops-btn');
            const devSection = document.getElementById('dev-drops-section');
            const userSection = document.getElementById('user-drops-section');
            
            if (type === 'dev') {
                // Switch to dev drops
                devBtn.className = 'flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors bg-blue-600 text-white';
                devBtn.innerHTML = 'üéØ Dev GeoDrops';
                
                userBtn.className = 'flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-300 hover:text-white';
                userBtn.innerHTML = 'üë§ User GeoDrops';
                
                devSection.style.display = 'block';
                userSection.style.display = 'none';
                window.currentListType = 'dev';
                
                // Load dev drops
                loadDevGeoDrops();
                
                showMessage('üéØ Dev GeoDrops angezeigt', false);
            } else if (type === 'user') {
                // Switch to user drops
                devBtn.className = 'flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-300 hover:text-white';
                devBtn.innerHTML = 'üéØ Dev GeoDrops';
                
                userBtn.className = 'flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors bg-green-600 text-white';
                userBtn.innerHTML = 'üë§ User GeoDrops';
                
                devSection.style.display = 'none';
                userSection.style.display = 'block';
                window.currentListType = 'user';
                
                // Load user drops
                loadUserGeoDrops();
                
                showMessage('üë§ User GeoDrops angezeigt', false);
            }
        };
        
        // Upload List Type Switching Functions - Override to ensure they work
        
        // Load Dev Drops for Upload - KOPIERTE L√ñSUNG
        window.loadDevDropsForUpload = async function() {
            console.log('üéØ Loading Dev Drops for Upload (KOPIERTE L√ñSUNG)...');
            console.log('üîç Firebase available:', !!window.firebase);
            console.log('üîç Firestore available:', !!(window.firebase && window.firebase.firestore));
            console.log('üîç Select element:', document.getElementById('geocard-drop-select'));
            
            try {
                if (!window.firebase || !window.firebase.firestore()) {
                    console.log('‚ùå Firebase not available');
                    return;
                }
                
                const db = window.firebase.firestore();
                console.log('üîç DB object:', db);
                
                // Load all dev drops and filter out claimed ones
                const allDevDropsSnapshot = await db.collection('devDrops').get();
                
                // Filter for available drops and exclude claimed drops for today
                const today = new Date().toDateString();
                const currentUser = window.currentUser || window.auth?.currentUser;
                
                const devDropsSnapshot = {
                    docs: allDevDropsSnapshot.docs.filter(doc => {
                        const data = doc.data();
                        const isAvailable = data.isAvailable === true;
                        
                        // Check if claimed today by current user
                        const lastClaimDate = data.lastClaimDate ? data.lastClaimDate.toDate().toDateString() : null;
                        const isClaimedToday = lastClaimDate === today && data.claimedBy === currentUser?.uid;
                        
                        // Only include drops that are available AND not claimed today
                        return isAvailable && !isClaimedToday;
                    }),
                    size: 0
                };
                devDropsSnapshot.size = devDropsSnapshot.docs.length;
                console.log('üìä Dev drops snapshot:', devDropsSnapshot.size, 'drops found');
                
                const devDrops = [];
                devDropsSnapshot.forEach(doc => {
                    devDrops.push({ id: doc.id, ...doc.data(), collection: 'devDrops' });
                });
                
                console.log('üìä Dev drops array:', devDrops.length, 'drops');
                
                // Sort drops by geodropNumber
                devDrops.sort((a, b) => {
                    const numA = parseInt(a.geodropNumber) || parseInt(a.id) || 0;
                    const numB = parseInt(b.geodropNumber) || parseInt(b.id) || 0;
                    return numA - numB;
                });
                
                // Update dev drops select - GENAU WIE DIE FUNKTIONIERENDE LISTE
                const select = document.getElementById('geocard-drop-select');
                console.log('üîç Select element found:', !!select);
                
                if (select && devDrops.length > 0) {
                    select.innerHTML = '<option value="">Dev GeoDrop ausw√§hlen...</option>';
                    devDrops.forEach(drop => {
                        const option = document.createElement('option');
                        option.value = `${drop.collection}:${drop.id}`;
                        option.textContent = `üéØ Dev GeoDrop${drop.geodropNumber || drop.id} - ${drop.reward || 100} PixelDrops`;
                        select.appendChild(option);
                    });
                    console.log(`‚úÖ Loaded ${devDrops.length} Dev Drops for Upload (KOPIERTE L√ñSUNG)`);
                } else if (select) {
                    select.innerHTML = '<option value="">Keine Dev Drops verf√ºgbar</option>';
                    console.log('‚ùå No dev drops found for upload');
                } else {
                    console.log('‚ùå Select element not found!');
                }
            } catch (error) {
                console.error('‚ùå Error loading Dev Drops for Upload (KOPIERTE L√ñSUNG):', error);
                showMessage('Fehler beim Laden der Dev Drops f√ºr Upload', true);
                
                const select = document.getElementById('geocard-drop-select');
                if (select) {
                    select.innerHTML = '<option value="">Fehler beim Laden</option>';
                }
            }
        };
        
        // Load User Drops for Upload
        window.loadUserDropsForUpload = async function() {
            console.log('üë§ Loading User Drops for Upload...');
            try {
                if (!window.firebase || !window.firebase.firestore()) {
                    console.log('‚ùå Firebase not available');
                    return;
                }
                
                const db = window.firebase.firestore();
                // Load all user drops and filter out claimed ones
                const allUserDropsSnapshot = await db.collection('userDrops').get();
                
                // Filter for active drops and exclude claimed drops for today
                const today = new Date().toDateString();
                const currentUser = window.currentUser || window.auth?.currentUser;
                
                const userDropsSnapshot = {
                    docs: allUserDropsSnapshot.docs.filter(doc => {
                        const data = doc.data();
                        const isActive = data.isActive === true;
                        
                        // Check if claimed today by current user
                        const lastClaimDate = data.lastClaimDate ? data.lastClaimDate.toDate().toDateString() : null;
                        const isClaimedToday = lastClaimDate === today && data.claimedBy === currentUser?.uid;
                        
                        // Only include drops that are active AND not claimed today
                        return isActive && !isClaimedToday;
                    }),
                    size: 0
                };
                userDropsSnapshot.size = userDropsSnapshot.docs.length;
                
                const userDrops = [];
                userDropsSnapshot.forEach(doc => {
                    userDrops.push({ id: doc.id, ...doc.data(), collection: 'userDrops' });
                });
                
                // Sort drops by geodropNumber
                userDrops.sort((a, b) => {
                    const numA = parseInt(a.geodropNumber) || parseInt(a.id) || 0;
                    const numB = parseInt(b.geodropNumber) || parseInt(b.id) || 0;
                    return numA - numB;
                });
                
                // Update user drops select
                const select = document.getElementById('geocard-user-drop-select');
                if (select) {
                    select.innerHTML = '<option value="">User GeoDrop ausw√§hlen...</option>';
                    userDrops.forEach(drop => {
                        const option = document.createElement('option');
                        option.value = `${drop.collection}:${drop.id}`;
                        option.textContent = `üë§ User GeoDrop${drop.geodropNumber || drop.id} - ${drop.reward || 100} PixelDrops`;
                        select.appendChild(option);
                    });
                }
                
                console.log(`‚úÖ Loaded ${userDrops.length} User Drops for Upload`);
            } catch (error) {
                console.error('‚ùå Error loading User Drops for Upload:', error);
                showMessage('Fehler beim Laden der User Drops f√ºr Upload', true);
            }
        };
        
        // Load Dev GeoDrops (only dev drops)
        window.loadDevGeoDrops = async function() {
            console.log('üéØ Loading Dev GeoDrops...');
            try {
                if (!window.firebase || !window.firebase.firestore()) {
                    console.log('‚ùå Firebase not available');
                    return;
                }
                
                const db = window.firebase.firestore();
                const devDropsSnapshot = await db.collection('devDrops').where('isAvailable', '==', true).get();
                
                const devDrops = [];
                devDropsSnapshot.forEach(doc => {
                    devDrops.push({ id: doc.id, ...doc.data(), collection: 'devDrops' });
                });
                
                // Sort drops by geodropNumber
                devDrops.sort((a, b) => {
                    const numA = parseInt(a.geodropNumber) || parseInt(a.id) || 0;
                    const numB = parseInt(b.geodropNumber) || parseInt(b.id) || 0;
                    return numA - numB;
                });
                
                // Update dev drops table
                const table = document.getElementById('geodrops-table');
                if (table && devDrops.length > 0) {
                    // Get current user for status check
                    let currentUser = window.currentUser;
                    if (!currentUser && window.auth && window.auth.currentUser) {
                        currentUser = window.auth.currentUser;
                    }
                    if (!currentUser && window.firebase && window.firebase.auth && window.firebase.auth().currentUser) {
                        currentUser = window.firebase.auth().currentUser;
                    }
                    
                    let tableHTML = '<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-gray-600"><th class="text-left p-2">Nr.</th><th class="text-left p-2">Reward</th><th class="text-left p-2">Status</th><th class="text-left p-2">Typ</th><th class="text-center p-2">Icon</th><th class="text-left p-2">Koordinaten</th></tr></thead><tbody>';
                    devDrops.forEach(drop => {
                        const coords = drop.lat && drop.lng ? `${drop.lat.toFixed(4)}, ${drop.lng.toFixed(4)}` : 'N/A';
                        // Check if claimed today with proper date comparison
                        const today = new Date().toDateString();
                        const lastClaimDate = drop.lastClaimDate ? drop.lastClaimDate.toDate().toDateString() : null;
                        const isClaimedToday = lastClaimDate === today && drop.claimedBy === currentUser?.uid;
                        const statusText = isClaimedToday ? '‚è∞ Heute gesammelt' : '‚úÖ Verf√ºgbar';
                        const rowClass = isClaimedToday ? 'border-b border-gray-700 bg-gray-800 opacity-60' : 'border-b border-gray-700';
                        const textClass = isClaimedToday ? 'text-gray-500' : 'text-white';
                        tableHTML += `<tr class="${rowClass}"><td class="p-2 ${textClass}">${drop.geodropNumber || drop.id}</td><td class="p-2 ${textClass}">${drop.reward || 100}</td><td class="p-2 ${textClass}">${statusText}</td><td class="p-2 ${textClass}">üéØ Dev</td><td class="p-2 text-center"><span class="text-2xl">üéØ</span></td><td class="p-2 text-xs ${textClass}">${coords}</td></tr>`;
                    });
                    tableHTML += '</tbody></table></div>';
                    table.innerHTML = tableHTML;
                } else if (table) {
                    table.innerHTML = '<div class="text-center text-gray-400 p-4">Keine Dev GeoDrops gefunden</div>';
                }
                
                console.log(`‚úÖ Loaded ${devDrops.length} Dev GeoDrops`);
            } catch (error) {
                console.error('‚ùå Error loading Dev GeoDrops:', error);
                showMessage('Fehler beim Laden der Dev GeoDrops', true);
                
                const table = document.getElementById('geodrops-table');
                if (table) {
                    table.innerHTML = '<div class="text-center text-red-400 p-4">Fehler beim Laden der Dev GeoDrops</div>';
                }
            }
        };
        
        // Load User GeoDrops (only user drops)
        window.loadUserGeoDrops = async function() {
            console.log('üë§ Loading User GeoDrops...');
            try {
                if (!window.firebase || !window.firebase.firestore()) {
                    console.log('‚ùå Firebase not available');
                    return;
                }
                
                const db = window.firebase.firestore();
                
                // Get current user
                let currentUser = window.currentUser;
                if (!currentUser && window.auth && window.auth.currentUser) {
                    currentUser = window.auth.currentUser;
                }
                if (!currentUser && window.firebase && window.firebase.auth && window.firebase.auth().currentUser) {
                    currentUser = window.firebase.auth().currentUser;
                }
                
                if (!currentUser) {
                    console.log('‚ùå User not logged in, cannot load user drops');
                    const userDropsTable = document.getElementById('user-drops-table');
                    if (userDropsTable) {
                        userDropsTable.innerHTML = '<div class="text-center text-red-400 p-4">Bitte zuerst anmelden</div>';
                    }
                    return;
                }
                
                // Load ALL user drops (not just current user's)
                const userDropsSnapshot = await db.collection('userDrops')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const userDrops = [];
                userDropsSnapshot.forEach(doc => {
                    userDrops.push({ id: doc.id, ...doc.data(), collection: 'userDrops' });
                });
                
                // Update user drops table
                const userDropsTable = document.getElementById('user-drops-table');
                if (userDropsTable && userDrops.length > 0) {
                    let tableHTML = '<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-gray-600"><th class="text-left p-2">Nr.</th><th class="text-left p-2">Reward</th><th class="text-left p-2">Status</th><th class="text-left p-2">Ersteller</th><th class="text-left p-2">Koordinaten</th><th class="text-left p-2">Erstellt</th><th class="text-center p-2">Icon</th><th class="text-left p-2">Aktionen</th></tr></thead><tbody>';
                    userDrops.forEach(drop => {
                        const coords = drop.lat && drop.lng ? `${drop.lat.toFixed(4)}, ${drop.lng.toFixed(4)}` : 'N/A';
                        const createdDate = drop.createdAt ? drop.createdAt.toDate().toLocaleDateString() : 'N/A';
                        const statusText = drop.isActive ? '‚úÖ Aktiv' : '‚ùå Inaktiv';
                        const statusClass = drop.isActive ? 'text-green-400' : 'text-red-400';
                        tableHTML += `
                            <tr class="border-b border-gray-700">
                                <td class="p-2 text-white">${drop.geodropNumber || drop.id}</td>
                                <td class="p-2 text-white">${drop.reward || 100}</td>
                                <td class="p-2 ${statusClass}">${statusText}</td>
                                <td class="p-2 text-white">${drop.ersteller || 'Unknown'}</td>
                                <td class="p-2 text-xs text-white">${coords}</td>
                                <td class="p-2 text-xs text-white">${createdDate}</td>
                                <td class="p-2 text-center">
                                    <span class="text-2xl">üéØ</span>
                                </td>
                                <td class="p-2">
                                    <button onclick="editUserDrop('${drop.id}')" class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 mr-1">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="toggleUserDrop('${drop.id}', ${drop.isActive})" class="px-2 py-1 ${drop.isActive ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'} text-white rounded text-xs">
                                        ${drop.isActive ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    tableHTML += '</tbody></table></div>';
                    userDropsTable.innerHTML = tableHTML;
                } else if (userDropsTable) {
                    userDropsTable.innerHTML = '<div class="text-center text-gray-400 p-4">Keine User GeoDrops gefunden</div>';
                }
                
                console.log(`‚úÖ Loaded ${userDrops.length} User GeoDrops`);
            } catch (error) {
                console.error('‚ùå Error loading User GeoDrops:', error);
                showMessage('Fehler beim Laden der User GeoDrops', true);
                
                const userDropsTable = document.getElementById('user-drops-table');
                if (userDropsTable) {
                    userDropsTable.innerHTML = '<div class="text-center text-red-400 p-4">Fehler beim Laden der User GeoDrops</div>';
                }
            }
        };
        
        // User Drop Creation Modal Functions
        
        window.closeCreateUserDropModal = function() {
            console.log('‚ùå Closing create user drop modal');
            const modal = document.getElementById('create-user-drop-modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚úÖ Modal closed successfully');
            } else {
                console.error('‚ùå Modal not found');
            }
        };
        
        window.useCurrentLocationForUserDrop = function() {
            console.log('üìç Using current location for user drop');
            if (window.currentLocation) {
                document.getElementById('user-drop-lat').value = window.currentLocation.lat.toFixed(6);
                document.getElementById('user-drop-lng').value = window.currentLocation.lng.toFixed(6);
                showMessage('üìç Aktuelle Position verwendet', false);
            } else {
                showMessage('‚ùå Keine aktuelle Position verf√ºgbar. Bitte zuerst Standort laden!', true);
            }
        };
        
        // Handle reference image upload and preview
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('user-drop-reference-image');
            if (imageInput) {
                imageInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        // Show preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.getElementById('user-drop-image-preview');
                            const previewImg = document.getElementById('user-drop-preview-img');
                            if (preview && previewImg) {
                                previewImg.src = e.target.result;
                                preview.style.display = 'block';
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
        
        // Use the createUserDrop function from geocard.js
        // This function is defined in geocard.js and will be used
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('create-user-drop-modal');
            if (modal && event.target === modal) {
                closeCreateUserDropModal();
            }
        });
        
        // Override functions to ensure they work
        
        window.switchToUploadListType = function(type) {
            console.log(`üîÑ Switching upload to ${type} drops list`);
            
            const devBtn = document.getElementById('upload-dev-drops-btn');
            const userBtn = document.getElementById('upload-user-drops-btn');
            const devSection = document.getElementById('upload-dev-drops-section');
            const userSection = document.getElementById('upload-user-drops-section');
            
            if (type === 'dev') {
                // Switch to dev drops for upload
                devBtn.className = 'flex-1 px-3 py-1 rounded-md text-xs font-medium transition-colors bg-blue-600 text-white';
                devBtn.innerHTML = 'üéØ Dev Drops';
                
                userBtn.className = 'flex-1 px-3 py-1 rounded-md text-xs font-medium transition-colors text-gray-300 hover:text-white';
                userBtn.innerHTML = 'üë§ User Drops';
                
                devSection.style.display = 'block';
                userSection.style.display = 'none';
                window.currentUploadListType = 'dev';
                
                // Load dev drops for upload
                if (typeof window.loadDevDropsForUpload === 'function') {
                    console.log('üîÑ Calling loadDevDropsForUpload from switch...');
                    window.loadDevDropsForUpload();
                } else {
                    console.log('‚ùå loadDevDropsForUpload function not available in switch');
                }
                
                showMessage('üéØ Dev Drops f√ºr Upload ausgew√§hlt', false);
            } else if (type === 'user') {
                // Switch to user drops for upload
                devBtn.className = 'flex-1 px-3 py-1 rounded-md text-xs font-medium transition-colors text-gray-300 hover:text-white';
                devBtn.innerHTML = 'üéØ Dev Drops';
                
                userBtn.className = 'flex-1 px-3 py-1 rounded-md text-xs font-medium transition-colors bg-green-600 text-white';
                userBtn.innerHTML = 'üë§ User Drops';
                
                devSection.style.display = 'none';
                userSection.style.display = 'block';
                window.currentUploadListType = 'user';
                
                // Load user drops for upload
                if (typeof window.loadUserDropsForUpload === 'function') {
                    window.loadUserDropsForUpload();
                }
                
                showMessage('üë§ User Drops f√ºr Upload ausgew√§hlt', false);
            }
        };
        
        // Edit User Drop function
        window.editUserDrop = function(dropId) {
            console.log('‚úèÔ∏è Editing User Drop:', dropId);
            
            // Get current user
            let currentUser = window.currentUser;
            if (!currentUser && window.auth && window.auth.currentUser) {
                currentUser = window.auth.currentUser;
            }
            if (!currentUser && window.firebase && window.firebase.auth && window.firebase.auth().currentUser) {
                currentUser = window.firebase.auth().currentUser;
            }
            
            if (!currentUser) {
                showMessage('‚ùå Bitte zuerst anmelden!', true);
                return;
            }
            
            // Show edit modal with current drop data
            showEditUserDropModal(dropId);
        };
        
        // Show Edit User Drop Modal
        window.showEditUserDropModal = async function(dropId) {
            console.log('‚úèÔ∏è Showing edit user drop modal for:', dropId);
            
            try {
                const db = window.firebase.firestore();
                const dropDoc = await db.collection('userDrops').doc(dropId).get();
                
                if (!dropDoc.exists) {
                    showMessage('‚ùå User Drop nicht gefunden!', true);
                    return;
                }
                
                const dropData = dropDoc.data();
                
                // Create edit modal
                const editModal = document.createElement('div');
                editModal.id = 'edit-user-drop-modal';
                editModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: block;';
                editModal.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
                        <div style="background: #374151; border-radius: 8px; max-width: 600px; width: 100%; padding: 24px;">
                            <h2 style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 16px; text-align: center;">‚úèÔ∏è User GeoDrop bearbeiten</h2>
                            
                            <div style="space-y: 16px;">
                                <!-- Drop Name -->
                                <div>
                                    <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üéØ Drop Name:</label>
                                    <input type="text" id="edit-user-drop-name" value="${dropData.name || ''}" style="width: 100%; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px;">
                                </div>
                                
                                <!-- Photo Description -->
                                <div>
                                    <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üì∏ Was soll fotografiert werden:</label>
                                    <textarea id="edit-user-drop-description" style="width: 100%; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px; height: 80px; resize: vertical;">${dropData.description || ''}</textarea>
                                </div>
                                
                                <!-- Reward -->
                                <div>
                                    <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üí∞ Belohnung (PixelDrops):</label>
                                    <input type="number" id="edit-user-drop-reward" value="${dropData.reward || 100}" min="10" max="1000" style="width: 100%; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px;">
                                </div>
                                
                                <!-- Coordinates -->
                                <div>
                                    <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üìç Koordinaten:</label>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="number" id="edit-user-drop-lat" step="0.000001" value="${dropData.lat || ''}" style="flex: 1; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px;">
                                        <input type="number" id="edit-user-drop-lng" step="0.000001" value="${dropData.lng || ''}" style="flex: 1; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px;">
                                    </div>
                                </div>
                                
                                <!-- Status -->
                                <div>
                                    <label style="color: white; font-weight: bold; margin-bottom: 8px; display: block;">üìä Status:</label>
                                    <select id="edit-user-drop-status" style="width: 100%; padding: 12px; background: #4B5563; border: 1px solid #6B7280; border-radius: 6px; color: white; font-size: 16px;">
                                        <option value="true" ${dropData.isActive ? 'selected' : ''}>‚úÖ Aktiv</option>
                                        <option value="false" ${!dropData.isActive ? 'selected' : ''}>‚ùå Inaktiv</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px; margin-top: 24px;">
                                <button onclick="saveUserDropEdit('${dropId}')" style="flex: 1; padding: 12px; background: #10B981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                    ‚úÖ √Ñnderungen speichern
                                </button>
                                <button onclick="closeEditUserDropModal()" style="flex: 1; padding: 12px; background: #6B7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                    ‚ùå Abbrechen
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(editModal);
                
            } catch (error) {
                console.error('‚ùå Error loading user drop for edit:', error);
                showMessage('‚ùå Fehler beim Laden des User Drops', true);
            }
        };
        
        // Close Edit User Drop Modal
        window.closeEditUserDropModal = function() {
            const modal = document.getElementById('edit-user-drop-modal');
            if (modal) {
                modal.remove();
            }
        };
        
        // Save User Drop Edit
        window.saveUserDropEdit = async function(dropId) {
            console.log('üíæ Saving user drop edit:', dropId);
            
            // Get form data
            const name = document.getElementById('edit-user-drop-name').value.trim();
            const description = document.getElementById('edit-user-drop-description').value.trim();
            const reward = parseInt(document.getElementById('edit-user-drop-reward').value) || 100;
            const lat = parseFloat(document.getElementById('edit-user-drop-lat').value);
            const lng = parseFloat(document.getElementById('edit-user-drop-lng').value);
            const isActive = document.getElementById('edit-user-drop-status').value === 'true';
            
            // Validation
            if (!name) {
                showMessage('‚ùå Bitte gib einen Drop-Namen ein!', true);
                return;
            }
            if (!description) {
                showMessage('‚ùå Bitte gib eine Beschreibung ein!', true);
                return;
            }
            if (isNaN(lat) || isNaN(lng)) {
                showMessage('‚ùå Bitte gib g√ºltige Koordinaten ein!', true);
                return;
            }
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showMessage('‚ùå Ung√ºltige Koordinaten!', true);
                return;
            }
            
            try {
                const db = window.firebase.firestore();
                
                // Update user drop document
                await db.collection('userDrops').doc(dropId).update({
                    name: name,
                    description: description,
                    photoDescription: description,
                    reward: reward,
                    lat: lat,
                    lng: lng,
                    isActive: isActive,
                    lastModified: new Date()
                });
                
                console.log('‚úÖ User drop updated:', dropId);
                showMessage(`‚úÖ User Drop "${name}" erfolgreich aktualisiert!`, false);
                
                // Close modal
                closeEditUserDropModal();
                
                // Reload user drops
                if (window.currentListType === 'user') {
                    loadUserGeoDrops();
                }
                if (window.currentUploadListType === 'user') {
                    loadUserDropsForUpload();
                }
                
                // Reload all drops for map only (not dropdown to avoid overwriting upload selection)
                // loadGeoDrops(); // REMOVED - was overwriting upload dropdown
                
            } catch (error) {
                console.error('‚ùå Error updating user drop:', error);
                showMessage('‚ùå Fehler beim Aktualisieren des User Drops: ' + error.message, true);
            }
        };
        
        // Toggle User Drop active status
        window.toggleUserDrop = async function(dropId, currentStatus) {
            console.log(`üîÑ Toggling User Drop ${dropId} from ${currentStatus ? 'active' : 'inactive'} to ${!currentStatus ? 'active' : 'inactive'}`);
            
            try {
                if (!window.firebase || !window.firebase.firestore()) {
                    showMessage('‚ùå Firebase nicht verf√ºgbar', true);
                    return;
                }
                
                const db = window.firebase.firestore();
                await db.collection('userDrops').doc(dropId).update({
                    isActive: !currentStatus,
                    lastModified: new Date()
                });
                
                showMessage(`‚úÖ User GeoDrop ${!currentStatus ? 'aktiviert' : 'deaktiviert'}`, false);
                
                // Reload user drops
                if (window.currentListType === 'user') {
                    loadUserGeoDrops();
                }
                if (window.currentUploadListType === 'user') {
                    loadUserDropsForUpload();
                }
                
                // Reload all drops for map only (not dropdown to avoid overwriting upload selection)
                // loadGeoDrops(); // REMOVED - was overwriting upload dropdown
                
            } catch (error) {
                console.error('‚ùå Error toggling User Drop:', error);
                showMessage('‚ùå Fehler beim √Ñndern des Status', true);
            }
        };
        
        // Close edit modal when clicking outside
        document.addEventListener('click', function(event) {
            const editModal = document.getElementById('edit-user-drop-modal');
            if (editModal && event.target === editModal) {
                closeEditUserDropModal();
            }
        });
        
        // CRITICAL: Define functions immediately to prevent undefined errors
        window.showCreateUserDropModal = function() {
            console.log('‚ûï Showing create user drop modal');
            const modal = document.getElementById('create-user-drop-modal');
            if (modal) {
                modal.style.display = 'block';
                
                // Check if user is Dev and show dev coordinates section
                const isDevLoggedIn = window.isDevLoggedIn || sessionStorage.getItem('devLoggedIn') === 'true';
                const devSection = document.getElementById('dev-coordinates-section');
                if (devSection) {
                    devSection.style.display = isDevLoggedIn ? 'block' : 'none';
                }
                
                // Set coordinate fields based on Dev status
                const latInput = document.getElementById('user-drop-lat');
                const lngInput = document.getElementById('user-drop-lng');
                
                if (isDevLoggedIn) {
                    // Dev users can edit coordinates
                    latInput.readOnly = false;
                    lngInput.readOnly = false;
                    latInput.style.background = '#4B5563';
                    lngInput.style.background = '#4B5563';
                    console.log('üîß Dev mode: Coordinates editable');
                } else {
                    // Normal users can only use current location
                    latInput.readOnly = true;
                    lngInput.readOnly = true;
                    latInput.style.background = '#374151';
                    lngInput.style.background = '#374151';
                    console.log('üë§ Normal user: Coordinates fixed to current location');
                }
                
                // Auto-fill current location if available
                if (window.currentLocation) {
                    document.getElementById('user-drop-lat').value = window.currentLocation.lat.toFixed(6);
                    document.getElementById('user-drop-lng').value = window.currentLocation.lng.toFixed(6);
                }
            } else {
                console.error('‚ùå Create user drop modal not found');
                showMessage('‚ùå Modal nicht gefunden', true);
            }
        };
        
        // Duplicate function removed - using the main one above
        
        // Override after page load to ensure they work
        window.addEventListener('load', function() {
            console.log('üîÑ Ensuring functions are available...');
            
            // Re-define functions to ensure they work
            window.showCreateUserDropModal = function() {
                console.log('‚ûï Showing create user drop modal (LOAD OVERRIDE)');
                const modal = document.getElementById('create-user-drop-modal');
                if (modal) {
                    modal.style.display = 'block';
                    
                    // Check if user is Dev and show dev coordinates section
                    const isDevLoggedIn = window.isDevLoggedIn || sessionStorage.getItem('devLoggedIn') === 'true';
                    const devSection = document.getElementById('dev-coordinates-section');
                    if (devSection) {
                        devSection.style.display = isDevLoggedIn ? 'block' : 'none';
                    }
                    
                    // Auto-fill current location if available
                    if (window.currentLocation) {
                        document.getElementById('user-drop-lat').value = window.currentLocation.lat.toFixed(6);
                        document.getElementById('user-drop-lng').value = window.currentLocation.lng.toFixed(6);
                    }
                } else {
                    console.error('‚ùå Create user drop modal not found');
                    showMessage('‚ùå Modal nicht gefunden', true);
                }
            };
            
            // Duplicate function removed - using the main one above
            
            console.log('‚úÖ Functions ensured to be available');
        });
    </script>
</body>
</html>
